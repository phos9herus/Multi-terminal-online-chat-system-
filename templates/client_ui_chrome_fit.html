<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Client</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    :root {
        --primary-color: #0084ff;
        --bg-gray: #f0f2f5;
        --sidebar-bg: #ffffff;
        --text-main: #1c1e21;
        --text-muted: #65676b;
        --msg-bubble-self: #0084ff;
        --msg-bubble-other: #e4e6eb;
        --error-red: #e74c3c;
        --unread-red: #ff3b30;
    }

    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-gray); margin: 0; overflow: hidden; color: var(--text-main); }

    .app-container { display: none; width: 100vw; height: 100vh; background: white; overflow: hidden; }

    /* Sidebar Layout */
    .sidebar { width: 320px; background: var(--sidebar-bg); border-right: 1px solid #ddd; display: flex; flex-direction: column; z-index: 10; height: 100vh; }
    .sidebar-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; height: 60px; box-sizing: border-box; }
    .sidebar-header h2 { font-size: 1.5rem; margin: 0; color: var(--primary-color); }

    .user-profile-bar { padding: 15px; background: #f9f9f9; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
    .my-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #ddd; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .my-info { flex: 1; overflow: hidden; }
    .my-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .my-uid { font-size: 0.75rem; color: #888; }

    /* ‰∫íÂä®‰∏éÂºïÁî®Ê†∑Âºè */
    .msg-bubble-container { position: relative; display: flex; flex-direction: column; }

    /* ËèúÂçïÊ†∑Âºè */
    .reaction-menu {
        position: absolute;
        top: 50%; transform: translateY(-50%); left: 100%; margin-left: 10px;
        background: white; padding: 4px 8px; border-radius: 50px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15); border: 1px solid #eee;
        display: none; align-items: center; gap: 8px; z-index: 100;
        opacity: 0; transition: opacity 0.2s;
    }
    .reaction-menu.show { display: flex; opacity: 1; }

    .menu-btn {
        width: 32px; height: 32px; border-radius: 50%; border: none; background: transparent;
        cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center;
        transition: 0.2s;
    }
    .menu-btn:hover { background: #f0f2f5; transform: scale(1.1); }
    .menu-btn.quote-btn { color: var(--primary-color); }

    .reaction-bar { display: flex; gap: 5px; margin-top: 4px; padding-left: 5px; }
    .reaction-pill {
        background: #fff; border: 1px solid #e4e6eb; border-radius: 12px;
        padding: 2px 8px; font-size: 0.75rem; color: #555;
        display: flex; align-items: center; gap: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .quote-preview-bar {
        display: none; position: absolute; bottom: 100%; left: 0; right: 0;
        background: rgba(249, 249, 249, 0.98); backdrop-filter: blur(10px);
        border-top: 1px solid #ddd; border-bottom: 1px solid #eee;
        padding: 12px 20px; z-index: 50; border-left: 5px solid var(--primary-color);
        box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
    }
    .quote-preview-content { flex: 1; font-size: 0.9rem; color: #444; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .quote-close-btn { background: none; border: none; cursor: pointer; color: #999; font-size: 1.2rem; margin-left: 10px; }
    .quote-close-btn:hover { color: var(--error-red); }

    .embedded-quote {
        background: #f7f7f7; border-left: 3px solid #ccc; border-radius: 4px;
        padding: 8px 10px; margin-bottom: 5px; cursor: pointer; position: relative;
        font-size: 0.85rem; color: #666; transition: 0.2s;
    }
    .embedded-quote:hover { background: #eee; border-left-color: var(--primary-color); }
    .quote-sender { font-weight: bold; font-size: 0.75rem; margin-bottom: 2px; color: #333; }

    .message-row.other .msg-bubble { cursor: pointer; transition: 0.2s; }
    .message-row.other .msg-bubble:hover { filter: brightness(0.97); }

    /* Chat Tabs */
    .chat-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
    .tab-item { padding: 12px 16px; display: flex; align-items: center; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; position: relative; height: 72px; box-sizing: border-box; }
    .tab-item:hover { background: #f5f6f7; }
    .tab-item.active { background: #e7f3ff; border-left-color: var(--primary-color); }

    .tab-avatar-container { position: relative; margin-right: 12px; }
    .tab-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
    .unread-dot {
        position: absolute; top: -2px; right: -2px; width: 12px; height: 12px;
        background: var(--unread-red); border-radius: 50%; border: 2px solid white;
        display: none; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .tab-item.unread .unread-dot { display: block; }

    .tab-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
    .tab-top { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; }
    .tab-name { font-weight: 600; font-size: 0.95rem; color: #050505; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
    .tab-time { font-size: 0.75rem; color: #bcc0c4; white-space: nowrap; margin-left: 5px; }
    .tab-preview { font-size: 0.85rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tab-item.unread .tab-preview { font-weight: 600; color: #050505; }

    .friends-menu-btn {
        padding: 15px; border-top: 1px solid #eee; background: #fff; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        font-weight: 600; color: #555; transition: background 0.2s;
    }
    .friends-menu-btn:hover { background: #f0f2f5; color: var(--primary-color); }

    /* Chat Area */
    .chat-area { flex: 1; display: flex; flex-direction: column; background: white; height: 100vh; }
    .chat-header { height: 60px; padding: 0 25px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .chat-header .title { font-weight: bold; font-size: 1.1rem; }
    .status-indicator { color:#2ecc71; font-size:0.8rem; display:flex; align-items:center; gap:5px; }

    .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #ffffff; }
    .message-row { display: flex; align-items: flex-start; width: 100%; animation: slideIn 0.2s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message-row.self { flex-direction: row-reverse; }
    .chat-avatar { width: 36px; height: 36px; border-radius: 50%; margin: 0 8px; object-fit: cover; flex-shrink: 0; border: 1px solid #eee; cursor: pointer; }
    .chat-avatar:hover { transform: scale(1.05); }

    .msg-content-group { display: flex; flex-direction: column; max-width: 65%; }
    .message-row.self .msg-content-group { align-items: flex-end; }
    .msg-timestamp { font-size: 0.7rem; color: #bcc0c4; margin-bottom: 4px; padding: 0 4px; }

    .msg-bubble { padding: 10px 16px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; }
    .message-row.other .msg-bubble { background: var(--msg-bubble-other); color: black; border-top-left-radius: 4px; }
    .message-row.self .msg-bubble { background: var(--msg-bubble-self); color: white; border-top-right-radius: 4px; }
    .chat-media { border-radius: 12px; max-width: 100%; max-height: 350px; cursor: pointer; border: 1px solid #eee; display: block; }

    .input-area { position: relative; padding: 15px 20px; border-top: 1px solid #eee; display: flex; align-items: center; gap: 12px; flex-shrink: 0; background: white; z-index: 20; }
    .msg-input { flex: 1; background: #f0f2f5; border: none; padding: 12px 20px; border-radius: 20px; outline: none; font-size: 15px; }
    .icon-btn { background: none; border: none; color: var(--primary-color); font-size: 1.4rem; cursor: pointer; }
    .upload-progress-container { width: 200px; padding: 10px; background: #fff; border: 1px solid var(--primary-color); border-radius: 8px; margin-top: 5px; }
    progress { width: 100%; height: 6px; border-radius: 3px; }

    /* Modals */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(2px); align-items: center; justify-content: center; }
    .modal-box { background: white; border-radius: 12px; padding: 30px; width: 350px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: popIn 0.2s ease; max-height: 80vh; overflow-y: auto; }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    #auth-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); z-index: 2000; display: flex; justify-content: center; align-items: center; overflow: hidden; }
    #auth-overlay .modal-box { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); z-index: 10; position: relative; }

    .breathing-halo { width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 20px auto; display: flex; justify-content: center; align-items: center; border: 3px solid var(--primary-color); background: white; color: var(--primary-color); font-size: 2.5rem; animation: halo-breathe 2.5s infinite ease-in-out; box-shadow: 0 0 20px rgba(0, 132, 255, 0.3); overflow: hidden; transition: all 0.3s ease; }
    @keyframes halo-breathe { 0%, 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 132, 255, 0.4); } 50% { transform: scale(1.05); box-shadow: 0 0 25px 10px rgba(0, 132, 255, 0.1); } }
    .breathing-halo img { width: 100%; height: 100%; object-fit: cover; animation: none; }

    .auth-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    .btn-full { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .btn-danger { background: #fff; color: var(--error-red); border: 1px solid var(--error-red); margin-top: 20px; }
    .btn-danger:hover { background: #fff5f5; }

    .orb { position: absolute; border-radius: 50%; filter: blur(10px); opacity: 0.6; z-index: 1; animation: float-orb infinite ease-in-out alternate; pointer-events: none; }
    @keyframes float-orb { 0% { transform: translate(0, 0) scale(1); } 33% { transform: translate(60px, 80px) scale(1.2); } 66% { transform: translate(-20px, 30px) scale(0.9); } 100% { transform: translate(50px, -30px) scale(1.05); } }

    .uc-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
    .uc-avatar { width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 3px solid #f0f2f5; }
    .uc-info { display: flex; flex-direction: column; }
    .uc-username { font-weight: bold; font-size: 1.1rem; }
    .uc-uid { font-size: 0.85rem; color: #888; background: #f0f2f5; padding: 2px 6px; border-radius: 4px; display: inline-block; align-self: flex-start; }
    .uc-actions { display: flex; gap: 10px; }
    .uc-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 5px; }

    .friend-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; position: relative; }
    .friend-item:hover { background: #f9f9f9; }
    .friend-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; border: 1px solid #eee; object-fit: cover;}
    .friend-actions { position: relative; margin-left: auto; }
    .friend-menu-btn { background: none; border: none; cursor: pointer; color: #999; padding: 5px 10px; font-size: 1.1rem; }
    .friend-dropdown { display: none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 100; min-width: 80px; }
    .friend-dropdown.show { display: block; }
    .friend-dropdown-item { padding: 8px 12px; font-size: 0.85rem; color: #333; cursor: pointer; white-space: nowrap; }
    .friend-dropdown-item:hover { background: #f5f5f5; color: var(--error-red); }

    .avatar-upload-container { display: flex; justify-content: center; margin-bottom: 25px; }
    .avatar-preview-wrapper { width: 90px; height: 90px; border-radius: 50%; margin: 0 auto 20px; overflow: hidden; cursor: pointer; border: 3px solid #f0f2f5; position: relative; }
    .avatar-preview-img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; color: white; opacity: 0; transition: 0.2s; font-size: 1.5rem; }
    .avatar-preview-wrapper:hover .avatar-overlay { opacity: 1; }

    #notification-bar { position: fixed; top: -80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 25px; border-radius: 50px; transition: top 0.4s; z-index: 3000; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    #notification-bar.show { top: 25px; }
</style>
</head>
<body>
    <div id="notification-bar"><span id="notify-content"></span></div>

    <div id="auth-overlay">
        <div class="modal-box" style="text-align:center;">
            <div id="login-halo" class="breathing-halo">
                <i class="fas fa-comments"></i>
            </div>
            <div id="login-status-indicator" style="margin-bottom: 20px; font-size: 0.85rem; font-weight: bold; color: #f39c12;">
                <i class="fas fa-circle-notch fa-spin"></i> Connecting to Server...
            </div>
            <p style="color:#666; font-size:0.9rem; margin-bottom:25px;">Secure Terminal Login</p>
            <input type="text" id="username" class="auth-input" placeholder="Username / UID">
            <input type="password" id="password" class="auth-input" placeholder="Password">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="code" class="auth-input" placeholder="Code" style="margin-bottom:0; text-align:center;">
                <button onclick="requestCode()" style="padding:0 15px; background:#e7f3ff; color:var(--primary-color); border:1px solid var(--primary-color); border-radius:8px; cursor:pointer; font-weight:600;">Get Code</button>
            </div>
            <button class="btn-full" onclick="doLogin()">Enter Chat</button>
        </div>
    </div>

    <div class="app-container" id="app">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Chats</h2>
                <i class="fas fa-cog" style="cursor:pointer; color:#888; font-size:1.1rem;" onclick="openSettings()"></i>
            </div>
            <div class="user-profile-bar">
                <img id="my-avatar-img" class="my-avatar" src="" onerror="this.src='https://ui-avatars.com/api/?name=Me'" onclick="openSettings()">
                <div class="my-info">
                    <div id="my-name-display" class="my-name">Guest</div>
                    <div id="my-uid-display" class="my-uid">UID: ---</div>
                </div>
            </div>

            <div class="chat-list" id="chat-tabs-container"></div>

            <div class="friends-menu-btn" onclick="openFriendsModal()">
                <i class="fas fa-user-friends"></i> Friends Menu
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <div class="title" id="current-chat-title">Global Chat Room</div>
                <div class="status-indicator"><i class="fas fa-circle" style="font-size:0.6rem;"></i> Online</div>
            </div>
            <div class="messages" id="msg-list"></div>
            <div class="input-area">
                <div id="quote-preview-bar" class="quote-preview-bar">
                    <div style="display:flex; flex-direction:column; overflow:hidden; flex:1;">
                        <span style="font-weight:bold; font-size:0.75rem; color:var(--primary-color); margin-bottom:2px;">
                            <i class="fas fa-reply"></i> Replying to <span id="quote-preview-sender">User</span>
                        </span>
                        <span id="quote-preview-text" class="quote-preview-content">...</span>
                    </div>
                    <button class="quote-close-btn" onclick="cancelQuote()"><i class="fas fa-times-circle"></i></button>
                </div>

                <button class="icon-btn" onclick="document.getElementById('media-upload').click()"><i class="fas fa-plus-circle"></i></button>
                <input type="file" id="media-upload" hidden accept="image/*,video/*" onchange="handleMediaUpload(this)">
                <input type="text" class="msg-input" id="msg-text" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMsg()">
                <button class="icon-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="user-card-overlay" onclick="closeUserCard()" style="display:none;">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="uc-header">
                <img id="uc-avatar" class="uc-avatar" src="">
                <div class="uc-info">
                    <div id="uc-username" class="uc-username">Username</div>
                    <div id="uc-uid" class="uc-uid">UID: ---</div>
                </div>
            </div>
            <div class="uc-actions">
                <button class="uc-btn" style="background:#e4e6eb; color:#000;" onclick="addFriendAction()"><i class="fas fa-user-plus"></i> Add Friend</button>
                <button class="uc-btn" style="background:var(--primary-color); color:#fff;" onclick="startPrivateChatFromCard()"><i class="fas fa-comment-dots"></i> Message</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="friends-modal" onclick="closeFriendsModal()" style="display:none;">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 style="margin-top:0;">My Friends</h3>
            <div id="friends-list-container" style="max-height: 300px; overflow-y:auto;">
                <p style="color:#999; text-align:center;">Loading...</p>
            </div>
            <button class="btn-full" style="margin-top:15px; background:#eee; color:#333;" onclick="closeFriendsModal()">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal" onclick="closeSettings()" style="display:none;">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 style="margin-top:0; text-align:center;">Settings</h3>
            <div class="avatar-upload-container">
                <div class="avatar-preview-wrapper" onclick="document.getElementById('st-avatar-input').click()">
                    <img id="settings-avatar-preview" class="avatar-preview-img" src="">
                    <div class="avatar-overlay"><i class="fas fa-camera"></i></div>
                </div>
                <input type="file" id="st-avatar-input" accept="image/*" hidden onchange="uploadAvatarImmediately(this)">
            </div>
            <input type="text" id="st-username" class="auth-input" placeholder="New Username">
            <input type="password" id="st-password" class="auth-input" placeholder="New Password" oninput="checkPasswordInput()">
            <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 5px; margin-top: 10px;">Chat History Limit (Default: 128)</label>
            <input type="number" id="st-history-limit" class="auth-input" placeholder="128" value="128">
            <div style="border-top: 1px solid #eee; margin: 15px 0; padding-top: 15px;">
                <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 5px;">Verification Code (For Password Change)</label>
                <input type="text" id="st-code" class="auth-input" placeholder="Enter Code">
                <button id="btn-settings-code" onclick="requestCode()" class="btn-full" style="margin-bottom: 10px; background:#e7f3ff; color:var(--primary-color); border: 1px solid var(--primary-color);" disabled>Get Verification Code</button>
            </div>
            <div id="st-error-msg" style="color:red; font-size:12px; margin-bottom:10px; display:none;">Need code to change password</div>
            <button class="btn-full" onclick="saveProfile()" style="background:#2ecc71;">Save Changes</button>
            <button class="btn-full btn-danger" onclick="doLogout()">Logout</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const SERVER_URL = "{{ server_url }}";
        const socket = io(SERVER_URL);

        let myInfo = { username: '', uid: '', avatar: '' };
        let currentTarget = 'global';
        let reactionDataCache = {};
        let lastReadMap = {};
        let friendsList = [];
        let currentCardUser = {};
        const renderedFingerprints = new Set();

        // --------------------------------------------------------
        // [GLOBAL HELPER] Áªü‰∏ÄËé∑ÂèñÂ§¥ÂÉè‰ª£ÁêÜURL
        // --------------------------------------------------------
        function getProxyUrl(targetUrl) {
            if (!targetUrl) return "";
            // Â¶ÇÊûúÊòØÊú¨Âú∞Â≠òÂÇ®Ë∑ØÂæÑÊàñBase64ÔºåÁõ¥Êé•ËøîÂõû
            if (targetUrl.startsWith('/local_storage') || targetUrl.startsWith('data:')) return targetUrl;
            // Â¶ÇÊûúÊòØÂ§ñÈÉ®ÂõæÂ∫ä (‰∏çÂê´ SERVER_URL)ÔºåÁõ¥Êé•ËøîÂõû
            if (targetUrl.startsWith('http') && !targetUrl.includes(SERVER_URL)) return targetUrl;

            // ÊèêÂèñÁõ∏ÂØπË∑ØÂæÑ
            let relPath = targetUrl;
            if (targetUrl.startsWith('http')) {
                relPath = targetUrl.replace(SERVER_URL, '');
            }

            // Âè™Êúâ /uploads ÂºÄÂ§¥ÊâçËµ∞‰ª£ÁêÜ
            if (relPath.startsWith('/uploads')) {
                return `/api/media_proxy?path=${encodeURIComponent(relPath)}`;
            }
            // ÂÖúÂ∫ïËøîÂõûÂéüË∑ØÂæÑ
            return targetUrl;
        }

        function getAvatarHelper(uid, avatarPath, username = 'User') {
            if (avatarPath) {
                return getProxyUrl(avatarPath);
            }
            // Â¶ÇÊûúÊ≤°ÊúâË∑ØÂæÑÔºåËØ¥ÊòéÈúÄË¶Å‰ªéÊúçÂä°Âô®Âä®ÊÄÅËé∑Âèñ
            // ‰ΩøÁî® /api/avatar/<uid> Êé•Âè£ÔºåÂπ∂Ëµ∞Êú¨Âú∞‰ª£ÁêÜ
            // ÊûÑÈÄ†: /api/media_proxy?path=/api/avatar/<uid>
            return `/api/media_proxy?path=${encodeURIComponent('/api/avatar/' + uid)}`;
        }

        // --------------------------------------------------------

        function initReadStatus() {
            fetch('/api/get_read_status').then(r => r.json()).then(data => {
                lastReadMap = { ...lastReadMap, ...data };
            });
        }

        socket.on('connect', () => console.log("[Socket] Connected"));

        socket.on('history_loaded', (data) => {
            if (data.target_uid === currentTarget || (data.target_uid === 'global' && currentTarget === 'global')) {
                renderMessages(data.messages, false);
            }
        });

        function parseTimestamp(tsStr) {
            if (!tsStr) return 0;
            return new Date(tsStr.replace(' ', 'T')).getTime();
        }

        // --- Main Polling Loop ---
        setInterval(() => {
            fetch('/api/status').then(r => r.json()).then(d => {
                // Connection state
                if (d.connection_status === 'Connected') isServerConnected = true;
                else isServerConnected = false;

                const statusLabel = document.getElementById('login-status-indicator');
                const loginBtn = document.querySelector('#auth-overlay .btn-full');

                if (statusLabel) {
                    if (d.connection_status === 'Connected') {
                        statusLabel.innerHTML = '<i class="fas fa-check-circle"></i> Server Connected';
                        statusLabel.style.color = '#2ecc71';
                        if(loginBtn) { loginBtn.disabled = false; loginBtn.style.opacity = "1"; }
                    } else {
                        statusLabel.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Connecting...';
                        statusLabel.style.color = '#e74c3c';
                        if(loginBtn) { loginBtn.disabled = true; loginBtn.style.opacity = "0.6"; }
                    }
                }

                if (d.verified) {
                    if (document.getElementById('auth-overlay').style.display !== 'none') {
                        // [INIT SESSION] ÁôªÂΩïÊàêÂäü
                        myInfo = { username: d.username, uid: d.uid, avatar: d.avatar };
                        document.getElementById('auth-overlay').style.display = 'none';
                        document.getElementById('app').style.display = 'flex';

                        document.getElementById('my-name-display').innerText = d.username;
                        document.getElementById('my-uid-display').innerText = "UID: " + d.uid;

                        // [FIXED] ‰ΩøÁî®‰ª£ÁêÜÊòæÁ§∫Ëá™Â∑±ÁöÑÂ§¥ÂÉè
                        if(d.avatar) document.getElementById('my-avatar-img').src = getProxyUrl(d.avatar);

                        fetchFriends();
                        initReadStatus();
                        switchChat('global', 'Global Chat Room');
                    } else if (myInfo.username !== d.username) {
                        myInfo.username = d.username;
                        document.getElementById('my-name-display').innerText = d.username;
                    }

                    if (d.messages) processDataAndRender(d.messages);
                }

                if (d.notification) {
                    const codeMatch = d.notification.match(/Verification Code:\s*(\d{6})/);
                    if (codeMatch) {
                         const code = codeMatch[1];
                         const inputs = [document.getElementById('code'), document.getElementById('st-code')];
                         inputs.forEach(i => { if(i) i.value = code; });
                    }
                    if(d.notification !== "Media sent!") showNotification(d.notification);
                    fetch('/api/clear_notification', { method: 'POST' });
                }
            });
        }, 800);

        function processDataAndRender(messages) {
            let conversations = {};
            conversations['global'] = { uid: 'global', username: 'Global Chat Room', avatar: '', lastMsg: null, unread: false };

            messages.forEach(m => {
               let key = null;
               if (!m.target_uid || m.target_uid === 'global') key = 'global';
               else if (m.uid === myInfo.uid) key = m.target_uid;
               else if (m.target_uid === myInfo.uid) key = m.uid;

               if (key) {
                   if (!conversations[key]) {
                        const friend = friendsList.find(f => f.uid === key);
                        const partnerName = friend ? friend.username : ((m.uid === myInfo.uid) ? 'User ' + key : m.sender);
                        // Ê≥®ÊÑèÔºöËøôÈáåÊàë‰ª¨ÊöÇÊó∂‰∏çÁ°ÆÂÆöÂ§¥ÂÉèË∑ØÂæÑÔºåÊ∏≤ÊüìÊó∂‰ºöÈÄöËøá UID Ëé∑Âèñ
                        conversations[key] = { uid: key, username: partnerName, avatar: (friend ? friend.avatar : null), lastMsg: null, unread: false };
                   }
                   conversations[key].lastMsg = m;
                   if (key !== 'global' && m.uid === key) conversations[key].username = m.sender;

                   if (key !== 'global' && m.uid !== myInfo.uid && currentTarget !== key) {
                         const msgTime = parseTimestamp(m.timestamp);
                         const lastReadTime = lastReadMap[key] || 0;
                         if (msgTime > lastReadTime) conversations[key].unread = true;
                   }
               }
            });

            if (currentTarget !== 'global' && !conversations[currentTarget]) {
                const friend = friendsList.find(f => f.uid === currentTarget);
                conversations[currentTarget] = {
                    uid: currentTarget,
                    username: friend ? friend.username : ('User ' + currentTarget),
                    avatar: (friend ? friend.avatar : null), lastMsg: null, unread: false
                };
            }
            renderSidebar(conversations);

            const relevantMsgs = messages.filter(m => {
                if (currentTarget === 'global') return !m.target_uid || m.target_uid === 'global';
                return (m.uid === myInfo.uid && m.target_uid === currentTarget) ||
                       (m.uid === currentTarget && m.target_uid === myInfo.uid);
            });

            if (relevantMsgs.length > 0) {
                renderMessages(relevantMsgs, false);
            }
        }

        function renderSidebar(convs) {
            const container = document.getElementById('chat-tabs-container');
            const sortedKeys = Object.keys(convs).sort((a, b) => {
                if (a === 'global') return -1; if (b === 'global') return 1;
                if (a === 'ADMIN') return -1; if (b === 'ADMIN') return 1;
                const timeA = convs[a].lastMsg ? convs[a].lastMsg.timestamp : '';
                const timeB = convs[b].lastMsg ? convs[b].lastMsg.timestamp : '';
                return timeB.localeCompare(timeA);
            });

            const validIds = new Set();

            sortedKeys.forEach(key => {
                const c = convs[key];
                const isActive = (key === currentTarget);
                const isGlobal = (key === 'global');
                let preview = "No messages";
                let timeStr = "";
                if (c.lastMsg) {
                    if (c.lastMsg.type === 'image') preview = "[Image]";
                    else if (c.lastMsg.type === 'video') preview = "[Video]";
                    else preview = c.lastMsg.content.substring(0, 15) + (c.lastMsg.content.length>15 ? "..." : "");
                    if (c.lastMsg.timestamp) {
                        const parts = c.lastMsg.timestamp.split(' ');
                        if(parts.length > 1) {
                            const timeParts = parts[1].split(':');
                            timeStr = `${timeParts[0]}:${timeParts[1]}`;
                        }
                    }
                } else if (key === 'ADMIN') {
                     preview = "System Administrator";
                }

                const domId = `tab-item-${c.uid}`;
                validIds.add(domId);
                let div = document.getElementById(domId);

                // [FIXED] ‰æßËæπÊ†èÂ§¥ÂÉèÈÄªËæë
                let avaSrc = "";
                if (isGlobal) avaSrc = "https://ui-avatars.com/api/?name=Global&background=0084ff&color=fff";
                else if (c.uid === 'ADMIN') avaSrc = "https://ui-avatars.com/api/?name=Admin&background=000&color=fff";
                else {
                    // ‰ΩøÁî®ÂÖ®Â±Ä HelperÔºå‰ºòÂÖàÁî®Â∑≤Êúâ pathÔºåÊ≤°ÊúâÂàôÁî® UID Êü•Êâæ
                    avaSrc = getAvatarHelper(c.uid, c.avatar, c.username);
                }

                if (div) {
                    const targetClass = `tab-item ${isActive ? 'active' : ''} ${c.unread ? 'unread' : ''}`;
                    if (div.className !== targetClass) div.className = targetClass;
                    const previewEl = div.querySelector('.tab-preview');
                    if (previewEl.innerText !== preview) previewEl.innerText = preview;
                    const timeEl = div.querySelector('.tab-time');
                    if (timeEl.innerText !== timeStr) timeEl.innerText = timeStr;
                    const nameEl = div.querySelector('.tab-name');
                    if (nameEl.innerText !== c.username) nameEl.innerText = c.username;

                    // Ê£ÄÊü•Â§¥ÂÉèÊòØÂê¶ÂèòÂåñ (ÁÆÄÂçïÂØπÊØî URL)
                    const img = div.querySelector('.tab-avatar');
                    if (img && img.getAttribute('src') !== avaSrc) {
                        img.src = avaSrc;
                    }

                    container.appendChild(div);
                } else {
                    div = document.createElement('div');
                    div.id = domId;
                    div.className = `tab-item ${isActive ? 'active' : ''} ${c.unread ? 'unread' : ''}`;
                    div.onclick = () => switchChat(c.uid, c.username);

                    div.innerHTML = `
                        <div class="tab-avatar-container">
                            <img src="${avaSrc}" class="tab-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${c.username}'">
                            <div class="unread-dot"></div>
                        </div>
                        <div class="tab-content">
                            <div class="tab-top">
                                <span class="tab-name">${c.username}</span>
                                <span class="tab-time">${timeStr}</span>
                            </div>
                            <div class="tab-preview">${preview}</div>
                        </div>
                    `;
                    container.appendChild(div);
                }
            });

            Array.from(container.children).forEach(child => {
                if (!validIds.has(child.id)) container.removeChild(child);
            });
        }

        let currentQuote = null;
        socket.on('reaction_update', (data) => {
            reactionDataCache[data.msg_id] = data.reactions;
            updateMessageReactions(data.msg_id, data.reactions);
        });

        function renderMessages(msgs, clearMode = false) {
            const list = document.getElementById('msg-list');
            let tempUploads = [];
            if (clearMode) {
                list.querySelectorAll('[id^="t_"]').forEach(el => tempUploads.push(el));
                list.innerHTML = '';
                renderedFingerprints.clear();
            }

            let hasNewContent = false;
            const hideAdminGlobal = localStorage.getItem('hide_admin_global') === 'true';

            msgs.forEach(msg => {
                if (currentTarget === 'global' && msg.uid === 'ADMIN' && hideAdminGlobal) return;

                const msgFingerprint = `${msg.uid}-${msg.timestamp}-${msg.content}`;
                if (renderedFingerprints.has(msgFingerprint)) return;
                renderedFingerprints.add(msgFingerprint);
                hasNewContent = true;

                if (msg.reactions) reactionDataCache[msg.id] = msg.reactions;
                else if (!reactionDataCache[msg.id]) reactionDataCache[msg.id] = {};

                const isSelf = (msg.uid === myInfo.uid);
                const row = document.createElement('div');
                row.className = `message-row ${isSelf ? 'self' : 'other'}`;
                const domId = `msg-${msg.id || msg.temp_id || Date.now()}`;
                row.id = domId;

                // [FIXED] Â™í‰ΩìË∑ØÂæÑÔºö‰ΩøÁî®‰ª£ÁêÜ
                let fullMediaUrl = msg.content;
                if (msg.content && typeof msg.content === 'string' && msg.content.startsWith('/uploads')) {
                    fullMediaUrl = `/api/media_proxy?path=${encodeURIComponent(msg.content)}`;
                }

                // [FIXED] Â§¥ÂÉèË∑ØÂæÑÔºö‰ΩøÁî®ÂÖ®Â±Ä Helper
                let avatarSrc = "";
                if (isSelf) {
                    // Ëá™Â∑±ÁöÑÂ§¥ÂÉè
                    avatarSrc = getAvatarHelper(myInfo.uid, myInfo.avatar, myInfo.username);
                } else {
                    // Âà´‰∫∫ÁöÑÂ§¥ÂÉè (ËøôÈáåÊàë‰ª¨Ê≤°Êúâ pathÔºåÂè™Êúâ uidÔºåÊâÄ‰ª•‰º† path=null)
                    // ‰ΩÜÂÆûÈôÖ‰∏ä msg ÈáåÈù¢Ê≤°Êúâ sender avatar pathÔºåÂè™Êúâ uid„ÄÇ
                    // ÊâÄ‰ª•Êàë‰ª¨Áõ¥Êé•Áî® /api/media_proxy?path=/api/avatar/<uid>
                    avatarSrc = getAvatarHelper(msg.uid, null, msg.sender);
                }

                let avatarHtml = '';
                const safeSender = msg.sender.replace(/'/g, "\\'");

                if (isSelf) {
                    avatarHtml = `<img src="${avatarSrc}" class="chat-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${myInfo.username}'">`;
                } else {
                    const safeAvatar = avatarSrc.replace(/'/g, "\\'");
                    avatarHtml = `<img src="${avatarSrc}" class="chat-avatar" onclick="showUserCard('${msg.uid}', '${safeSender}', '${safeAvatar}')" onerror="this.src='https://ui-avatars.com/api/?name=${safeSender}'">`;
                }

                let quoteHtml = '';
                if (msg.quote) {
                    let qContent = msg.quote.content;
                    if (msg.quote.type === 'image') qContent = '[Image]';
                    else if (msg.quote.type === 'video') qContent = '[Video]';
                    quoteHtml = `
                        <div class="embedded-quote" onclick="jumpToMessage('${msg.quote.id}')">
                            <div class="quote-sender"><i class="fas fa-quote-left"></i> ${msg.quote.sender}</div>
                            <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${qContent}</div>
                        </div>`;
                }

                let contentHtml = '';
                const safeContent = msg.content ? msg.content.replace(/'/g, "\\'") : "";
                const showMenu = !isSelf;
                const menuAction = showMenu ? `onclick="toggleReactionMenu('${domId}', '${msg.id}', '${safeSender}', '${safeContent}')"` : "";
                const cursorStyle = showMenu ? 'cursor:pointer' : '';

                if (msg.type === 'image') {
                    if (isSelf) {
                        contentHtml = `<img src="${fullMediaUrl}" class="chat-media" onclick="window.open(this.src)" loading="lazy">`;
                    } else {
                        contentHtml = `<img src="${fullMediaUrl}" class="chat-media" style="${cursorStyle}" ${menuAction} loading="lazy">`;
                    }
                } else if (msg.type === 'video') {
                    contentHtml = `<video src="${fullMediaUrl}" class="chat-media" controls preload="metadata"></video>`;
                } else {
                    contentHtml = `<div class="msg-bubble" style="${cursorStyle}" ${menuAction}>${msg.content}</div>`;
                }

                let menuHtml = '';
                if (showMenu) {
                    menuHtml = `
                        <div id="menu-${domId}" class="reaction-menu">
                            <button class="menu-btn quote-btn" title="Reply" onclick="event.stopPropagation(); startQuote('${msg.id}', '${safeSender}', '${safeContent}', '${msg.type}')"><i class="fas fa-reply"></i></button>
                            <button class="menu-btn" onclick="event.stopPropagation(); sendReaction('${msg.id}', 'like')">üëç</button>
                            <button class="menu-btn" onclick="event.stopPropagation(); sendReaction('${msg.id}', 'love')">‚ù§Ô∏è</button>
                            <button class="menu-btn" onclick="event.stopPropagation(); sendReaction('${msg.id}', 'question')">‚ùì</button>
                            <button class="menu-btn" onclick="event.stopPropagation(); sendReaction('${msg.id}', 'dislike')">üëé</button>
                        </div>`;
                }

                let reactionBarHtml = `<div id="reaction-bar-${msg.id}" class="reaction-bar"></div>`;
                const cachedReactions = reactionDataCache[msg.id] || {};
                if (Object.keys(cachedReactions).length > 0) {
                    reactionBarHtml = `<div id="reaction-bar-${msg.id}" class="reaction-bar">${buildReactionHtml(cachedReactions)}</div>`;
                }

                row.innerHTML = `
                    ${avatarHtml}
                    <div class="msg-content-group">
                        <div class="msg-timestamp">${msg.timestamp || ''}</div>
                        <div class="msg-bubble-container">
                            ${quoteHtml}
                            ${contentHtml}
                            ${menuHtml}
                        </div>
                        ${reactionBarHtml}
                    </div>`;
                list.appendChild(row);
            });

            if (clearMode) tempUploads.forEach(el => list.appendChild(el));
            if (hasNewContent || clearMode) list.scrollTop = list.scrollHeight;
        }

        function buildReactionHtml(reactions) {
            const icons = { 'like': 'üëç', 'love': '‚ù§Ô∏è', 'question': '‚ùì', 'dislike': 'üëé' };
            let html = '';
            for (let [type, count] of Object.entries(reactions)) {
                if (count > 0 && icons[type]) {
                    html += `<div class="reaction-pill">${icons[type]} ${count}</div>`;
                }
            }
            return html;
        }

        function toggleReactionMenu(domId, msgId, sender, content) {
            document.querySelectorAll('.reaction-menu').forEach(el => {
                if (el.id !== `menu-${domId}`) el.classList.remove('show');
            });
            const menu = document.getElementById(`menu-${domId}`);
            if(menu) {
                menu.classList.toggle('show');
                if(menu.classList.contains('show')) {
                    setTimeout(() => {
                        const closer = (e) => {
                            if(!e.target.closest(`#${domId}`)) {
                                menu.classList.remove('show');
                                window.removeEventListener('click', closer);
                            }
                        };
                        window.addEventListener('click', closer);
                    }, 0);
                }
            }
        }

        function sendReaction(msgId, type) {
            if(!msgId) return;
            if (!reactionDataCache[msgId]) reactionDataCache[msgId] = {};
            const currentCount = reactionDataCache[msgId][type] || 0;
            reactionDataCache[msgId][type] = currentCount + 1;
            updateMessageReactions(msgId, reactionDataCache[msgId]);

            fetch('/api/send_reaction', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    msg_id: msgId, reaction_type: type, target_uid: currentTarget
                })
            }).catch(err => console.error("Reaction failed:", err));
            document.querySelectorAll('.reaction-menu').forEach(el => el.classList.remove('show'));
        }

        function updateMessageReactions(msgId, reactions) {
            const bar = document.getElementById(`reaction-bar-${msgId}`);
            if(bar) bar.innerHTML = buildReactionHtml(reactions);
        }

        function startQuote(msgId, sender, content, type = 'text') {
            currentQuote = { id: msgId, sender: sender, content: content, type: type };
            const bar = document.getElementById('quote-preview-bar');
            if (bar) {
                bar.style.display = 'flex';
                document.getElementById('quote-preview-sender').innerText = sender;
                let displayText = content;
                if (type === 'image') displayText = '[Image]';
                else if (type === 'video') displayText = '[Video]';
                document.getElementById('quote-preview-text').innerText = displayText;
                document.getElementById('msg-text').focus();
            }
            document.querySelectorAll('.reaction-menu').forEach(el => el.classList.remove('show'));
        }

        function cancelQuote() {
            currentQuote = null;
            document.getElementById('quote-preview-bar').style.display = 'none';
        }

        function jumpToMessage(msgId) {
            const target = document.getElementById(`msg-${msgId}`);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                target.style.transition = 'background 0.5s';
                target.style.backgroundColor = '#fff3cd';
                setTimeout(() => target.style.backgroundColor = 'transparent', 1500);
            } else {
                showNotification("Message not in current view (too old).");
            }
        }

        let currentRoomMessages = [];

        function fetchServerHistory(uid) {
            const limit = parseInt(localStorage.getItem('chat_history_limit')) || 128;
            fetch('/api/request_history', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ target_uid: uid, limit: limit })
            }).then(r => r.json()).then(resp => {
                if (resp.status === 'ok') {
                    if (resp.messages.length > 0) mergeAndRender(resp.messages);
                    else if (currentRoomMessages.length === 0) {
                        document.getElementById('msg-list').innerHTML = `<div style="text-align:center; padding-top:50px; color:#ccc;">No history found.</div>`;
                    }
                }
            }).catch(err => console.error("Server history error:", err));
        }

        function switchChat(uid, name) {
            currentTarget = uid;
            currentRoomMessages = [];
            const nowTs = Date.now();
            lastReadMap[uid] = nowTs;
            fetch('/api/update_read_status', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ target_uid: uid, timestamp: nowTs })
            });
            document.getElementById('current-chat-title').innerText = name || (uid === 'global' ? 'Global Chat Room' : 'Chat');
            const list = document.getElementById('msg-list');
            list.innerHTML = '';
            renderedFingerprints.clear();

            fetch('/api/get_local_history', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ target_uid: uid })
            }).then(r => r.json()).then(resp => {
                if (resp.status === 'ok' && resp.messages.length > 0) mergeAndRender(resp.messages);
            }).finally(() => {
                fetchServerHistory(uid);
            });
        }

        function mergeAndRender(newMsgs) {
            newMsgs.forEach(msg => {
                const exists = currentRoomMessages.some(m => m.id === msg.id || (m.timestamp === msg.timestamp && m.content === msg.content && m.uid === msg.uid));
                if (!exists) currentRoomMessages.push(msg);
            });
            currentRoomMessages.sort((a, b) => {
                const ta = new Date(a.timestamp.replace(' ', 'T')).getTime();
                const tb = new Date(b.timestamp.replace(' ', 'T')).getTime();
                return ta - tb;
            });
            renderMessages(currentRoomMessages, true);
        }

        function sendMsg() {
            const input = document.getElementById('msg-text');
            const text = input.value.trim();
            if(!text) return;
            const payload = { content: text, type: 'text', target_uid: currentTarget, quote: currentQuote };
            fetch('/api/send_message', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            input.value = '';
            lastReadMap[currentTarget] = Date.now();
            if(currentQuote) cancelQuote();
        }

        async function handleMediaUpload(input) {
            if (!input.files[0]) return;
            let file = input.files[0];
            const originalSizeKB = file.size / 1024;
            const targetLimitKB = 4096;

            if (originalSizeKB > targetLimitKB && file.type.startsWith('image/')) {
                showNotification(`Image is too large (${Math.round(originalSizeKB)}KB). Compressing to < 4MB...`);
                file = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width; canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);
                            let quality = 0.95;
                            let resultBlob = null;
                            const getBlob = (q) => {
                                const dataUrl = canvas.toDataURL('image/jpeg', q);
                                const byteString = atob(dataUrl.split(',')[1]);
                                const ab = new ArrayBuffer(byteString.length);
                                const ia = new Uint8Array(ab);
                                for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
                                return new Blob([ab], { type: 'image/jpeg' });
                            };
                            resultBlob = getBlob(quality);
                            while (resultBlob.size / 1024 > targetLimitKB && quality > 0.1) {
                                quality -= 0.05; resultBlob = getBlob(quality);
                            }
                            console.log(`Compressed to: ${Math.round(resultBlob.size/1024)}KB`);
                            resolve(resultBlob);
                        };
                    };
                });
            }

            const finalSizeKB = file.size / 1024;
            if (finalSizeKB > targetLimitKB) {
                showNotification(`Unable to compress under 4MB (Current: ${Math.round(finalSizeKB)}KB).`);
                input.value = ''; return;
            }

            const tempId = "t_" + Date.now();
            const list = document.getElementById('msg-list');
            const row = document.createElement('div');
            row.className = "message-row self"; row.id = tempId;
            row.innerHTML = `
                <div class="msg-content-group">
                    <div class="upload-progress-container">
                        <div style="font-size:11px; font-weight:bold;">Uploading...</div>
                        <progress id="p-${tempId}" value="0" max="100"></progress>
                    </div>
                </div>`;
            list.appendChild(row); list.scrollTop = list.scrollHeight;

            const fd = new FormData();
            const fileName = (file.name && file.name !== 'image.jpg') ? file.name : "compressed_image.jpg";
            fd.append('file', file, fileName);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', SERVER_URL + '/api/upload_media', true);
            xhr.upload.onprogress = (e) => {
                if(e.lengthComputable) {
                    const prog = document.getElementById(`p-${tempId}`);
                    if(prog) prog.value = (e.loaded / e.total) * 100;
                }
            };
            xhr.onload = () => {
                if (xhr.status === 200) {
                    const r = JSON.parse(xhr.responseText);
                    fetch('/api/send_message', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ content: r.url, type: file.type.startsWith('video') ? 'video' : 'image', target_uid: currentTarget })
                    });
                    row.remove();
                } else {
                    showNotification("Upload failed: " + (JSON.parse(xhr.responseText).msg || "Error"));
                    row.remove();
                }
            };
            xhr.onerror = () => { showNotification("Network error."); row.remove(); };
            xhr.send(fd); input.value = '';
        }

        function fetchFriends() {
            fetch('/api/get_friends').then(r => r.json()).then(data => {
                friendsList = data;
                const modal = document.getElementById('friends-modal');
                if (modal && modal.style.display === 'flex') openFriendsModal();
            }).catch(e => console.error("Fetch friends error:", e));
        }

        function showUserCard(uid, username, avatarSrc) {
            if (uid === myInfo.uid) return;
            currentCardUser = { uid, username, avatar: avatarSrc };
            // [FIXED] UserCard ‰πüË¶ÅËµ∞‰ª£ÁêÜ
            document.getElementById('uc-avatar').src = getAvatarHelper(uid, avatarSrc, username);
            document.getElementById('uc-username').innerText = username;
            document.getElementById('uc-uid').innerText = "UID: " + uid;
            document.getElementById('user-card-overlay').style.display = 'flex';
        }

        function closeUserCard() { document.getElementById('user-card-overlay').style.display = 'none'; }

        function startPrivateChatFromCard() {
            if(currentCardUser.uid) {
                switchChat(currentCardUser.uid, currentCardUser.username);
                closeUserCard();
            }
        }

        function addFriendAction() {
            fetch('/api/add_friend', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(currentCardUser)
            }).then(r => r.json()).then(d => {
                if(d.status === 'ok') { showNotification("Friend Added!"); fetchFriends(); }
                else if (d.status === 'exists') showNotification("Already Friends");
            });
            closeUserCard();
        }

        function openFriendsModal() {
            const container = document.getElementById('friends-list-container');
            container.innerHTML = '';
            const displayList = [{uid: 'ADMIN', username: 'System Admin', avatar: ''}, ...friendsList];

            if (displayList.length === 0) container.innerHTML = '<p style="color:#999; text-align:center;">No friends found.</p>';
            else {
                displayList.forEach(f => {
                    const div = document.createElement('div');
                    div.className = 'friend-item';
                    div.onclick = () => { switchChat(f.uid, f.username); closeFriendsModal(); };

                    // [FIXED] Friend List Avatar
                    let ava = "";
                    if(f.uid === 'ADMIN') ava = "https://ui-avatars.com/api/?name=Admin&background=000&color=fff";
                    else ava = getAvatarHelper(f.uid, f.avatar, f.username);

                    let menuHtml = '';
                    if (f.uid !== 'ADMIN') {
                        menuHtml = `
                            <div class="friend-actions" onclick="event.stopPropagation()">
                                <button class="friend-menu-btn" onclick="toggleFriendMenu(this, '${f.uid}')">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div id="f-menu-${f.uid}" class="friend-dropdown">
                                    <div class="friend-dropdown-item" onclick="deleteFriend('${f.uid}')">Delete</div>
                                </div>
                            </div>`;
                    }

                    div.innerHTML = `
                        <img src="${ava}" class="friend-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${f.username}'">
                        <div style="flex:1;">
                            <div style="font-weight:bold;">${f.username}</div>
                            <div style="font-size:0.8rem; color:#888;">UID: ${f.uid}</div>
                        </div>
                        ${menuHtml}`;
                    container.appendChild(div);
                });
            }
            document.getElementById('friends-modal').style.display = 'flex';
        }

        function toggleFriendMenu(btn, uid) {
            document.querySelectorAll('.friend-dropdown').forEach(el => el.classList.remove('show'));
            const menu = document.getElementById(`f-menu-${uid}`);
            if (menu) menu.classList.toggle('show');
        }

        function deleteFriend(uid) {
            if(!confirm("Are you sure?")) return;
            fetch('/api/delete_friend', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ uid: uid })
            }).then(r => r.json()).then(data => {
                if(data.status === 'ok') {
                    friendsList = friendsList.filter(f => f.uid !== uid);
                    openFriendsModal(); showNotification("Friend deleted");
                }
            });
        }

        window.addEventListener('click', function(e) {
            if (!e.target.closest('.friend-actions')) document.querySelectorAll('.friend-dropdown').forEach(el => el.classList.remove('show'));
        });

        function closeFriendsModal() { document.getElementById('friends-modal').style.display = 'none'; }

        function openSettings() {
            const prev = document.getElementById('settings-avatar-preview');
            // [FIXED] Settings Avatar
            if(myInfo.avatar) prev.src = getProxyUrl(myInfo.avatar);
            else prev.src = `https://ui-avatars.com/api/?name=${myInfo.username}`;

            document.getElementById('st-username').value = '';
            document.getElementById('st-password').value = '';
            document.getElementById('st-code').value = '';
            document.getElementById('st-history-limit').value = localStorage.getItem('chat_history_limit') || 128;
            document.getElementById('st-error-msg').style.display='none';
            document.getElementById('settings-modal').style.display='flex';
        }
        function closeSettings() { document.getElementById('settings-modal').style.display='none'; }

        function checkPasswordInput() {
            const v = document.getElementById('st-password').value;
            document.getElementById('btn-settings-code').disabled = (v.length === 0);
        }

        function uploadAvatarImmediately(input) {
            if(input.files[0]) {
                const r = new FileReader();
                r.onload = e => {
                    const b64 = e.target.result;
                    document.getElementById('settings-avatar-preview').src = b64;
                    document.getElementById('my-avatar-img').src = b64;
                    fetch('/api/update_profile', {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({ new_avatar: b64 })
                    }).then(() => showNotification("Avatar Updated!"));
                };
                r.readAsDataURL(input.files[0]);
            }
        }

        function saveProfile() {
            const u = document.getElementById('st-username').value.trim();
            const p = document.getElementById('st-password').value.trim();
            const c = document.getElementById('st-code').value.trim();
            const l = document.getElementById('st-history-limit').value.trim();
            if(l) localStorage.setItem('chat_history_limit', l);
            const hideCheckbox = document.getElementById('st-hide-admin-global');
            if (hideCheckbox) {
                localStorage.setItem('hide_admin_global', hideCheckbox.checked);
                if (currentTarget === 'global') switchChat('global', 'Global Chat Room');
            }

            if(p && !c) { document.getElementById('st-error-msg').style.display='block'; return; }
            const data = {};
            if(u) data.new_username = u;
            if(p) { data.new_password = p; data.code = c; }

            if(Object.keys(data).length > 0) {
                fetch('/api/update_profile', {
                    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)
                }).then(() => {
                    showNotification("Settings Saved");
                    if(u) { myInfo.username = u; document.getElementById('my-name-display').innerText = u; }
                    closeSettings();
                });
            } else {
                showNotification("Settings Saved"); closeSettings();
            }
        }

        function showNotification(msg) {
            const bar = document.getElementById('notification-bar');
            document.getElementById('notify-content').innerHTML = msg;
            bar.classList.add('show');
            setTimeout(() => bar.classList.remove('show'), 4000);
        }
        function requestCode() { fetch('/api/request_code', {method:'POST'}); }
        function doLogin() {
            const data = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                code: document.getElementById('code').value
            };
            fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        }
        function doLogout() {
            myInfo = { username: '', uid: '', avatar: '' };
            if (typeof previousMsgCount !== 'undefined') previousMsgCount = 0;
            lastReadMap = {};
            fetch('/api/logout', {method:'POST'}).then(() => window.location.reload());
        }

        function initRandomBackground() {
            const overlay = document.getElementById('auth-overlay');
            if(!overlay) return;
            const oldOrbs = overlay.querySelectorAll('.orb');
            oldOrbs.forEach(el => el.remove());
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            const count = Math.floor(Math.random() * (6 - 3 + 1)) + 3;
            const colors = ['#0084ff', '#9b59b6', '#1abc9c', '#3498db', '#e67e22', '#2ecc71', '#e74c3c'];
            const placedOrbs = [];

            for (let i = 0; i < count; i++) {
                let orbData = null;
                let attempts = 0;
                while (attempts < 100) {
                    const maxSize = Math.min(500, Math.min(winW, winH) * 0.6);
                    const size = Math.floor(Math.random() * (maxSize - 200 + 1)) + 200;
                    const radius = size / 2;
                    const left = Math.floor(Math.random() * (winW - size));
                    const top = Math.floor(Math.random() * (winH - size));
                    const centerX = left + radius;
                    const centerY = top + radius;
                    let overlap = false;
                    for (const existing of placedOrbs) {
                        const dx = centerX - existing.x;
                        const dy = centerY - existing.y;
                        if (Math.sqrt(dx * dx + dy * dy) < (radius + existing.radius)) { overlap = true; break; }
                    }
                    if (!overlap) { orbData = { left, top, size, radius, x: centerX, y: centerY }; placedOrbs.push(orbData); break; }
                    attempts++;
                }
                if (!orbData) continue;
                const orb = document.createElement('div');
                orb.classList.add('orb');
                orb.style.width = orbData.size + 'px'; orb.style.height = orbData.size + 'px';
                orb.style.left = orbData.left + 'px'; orb.style.top = orbData.top + 'px';
                orb.style.background = colors[Math.floor(Math.random() * colors.length)];
                orb.style.animationDuration = (Math.floor(Math.random() * 17) + 18) + 's';
                orb.style.animationDelay = (Math.floor(Math.random() * 10) * -1) + 's';
                overlay.prepend(orb);
            }
        }

        window.addEventListener('load', initRandomBackground);
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer); resizeTimer = setTimeout(initRandomBackground, 300);
        });

        // ÁôªÂΩïÈ°µËæìÂÖ•ÁõëÂê¨
        let userCheckTimer;
        const usernameInput = document.getElementById('username');
        const halo = document.getElementById('login-halo');
        let isServerConnected = false;

        usernameInput.addEventListener('input', function(e) {
            const val = e.target.value.trim();
            if (!isServerConnected || val.length === 0) { resetHalo(); return; }
            clearTimeout(userCheckTimer);
            userCheckTimer = setTimeout(() => {
                fetch('/api/check_user', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: val})
                }).then(r => r.json()).then(data => {
                    if (data.exists) {
                        // [FIXED] Login Avatar Proxy
                        let avatarUrl = '';
                        if (data.avatar) avatarUrl = getProxyUrl(data.avatar);
                        else avatarUrl = `https://ui-avatars.com/api/?name=${val}&background=random`;
                        halo.innerHTML = `<img src="${avatarUrl}" onerror="this.src='https://ui-avatars.com/api/?name=${val}'">`;
                    } else resetHalo();
                }).catch(err => console.error("User check failed:", err));
            }, 500);
        });

        function resetHalo() {
            if (!halo.querySelector('i')) halo.innerHTML = '<i class="fas fa-comments"></i>';
        }
    </script>
</body>
</html>