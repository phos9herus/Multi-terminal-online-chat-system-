<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Server Admin Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #1a1d21; color: #ecf0f1; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* 三栏布局 */
        .col-users { width: 280px; background: #22252b; border-right: 1px solid #34373c; display: flex; flex-direction: column; }
        .col-rooms { width: 220px; background: #2c3e50; border-right: 1px solid #34495e; display: flex; flex-direction: column; }
        .col-chat  { flex: 1; display: flex; flex-direction: column; background: #1a1d21; min-width: 400px; }

        /* 通用标题 */
        .section-header { padding: 15px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .list-container { flex: 1; overflow-y: auto; padding: 10px; }

        /* 用户卡片样式 */
        .user-card {
            background: #2c3036; border-radius: 8px; padding: 10px; margin-bottom: 10px;
            border: 1px solid #3a3f47; transition: 0.2s;
        }
        .user-card:hover { background: #353a42; }
        .uc-top { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .uc-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #ddd; }

        .uc-info { flex: 1; overflow: hidden; }
        .uc-name { font-weight: bold; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .uc-uid { font-size: 0.75rem; color: #888; }

        .uc-details { font-size: 0.75rem; color: #aaa; background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px; }
        .uc-row { display: flex; justify-content: space-between; margin-bottom: 2px; }

        /* 在线状态点 */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .status-online { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .status-offline { background: #95a5a6; }

        /* 聊天室列表样式 (保留之前的风格) */
        .room-card { padding: 12px; background: #34495e; border-radius: 6px; margin-bottom: 8px; cursor: pointer; border-left: 4px solid transparent; }
        .room-card:hover { background: #465c71; }
        .room-card.active { border-left-color: #2ecc71; background: #3e5871; }
        .room-title { font-weight: bold; font-size: 0.9em; }

        /* 聊天区域 (保留) */
        .chat-container { flex: 1; padding: 20px; overflow-y: auto; }
        .input-area { padding: 15px; background: #2c3e50; border-top: 1px solid #34495e; display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border-radius: 4px; border: none; background: #34495e; color: white; outline: none; }
        button { padding: 10px 20px; background: #2980b9; border: none; color: white; border-radius: 4px; cursor: pointer; }

        .msg-row { margin-bottom: 15px; border-bottom: 1px solid #2c3e50; padding-bottom: 10px; }
        .msg-meta { font-size: 0.8em; color: #f39c12; margin-bottom: 5px; }
        .msg-content { background: #2c3e50; padding: 8px 12px; border-radius: 6px; display: inline-block; color: #ecf0f1;}
        .media-preview { max-width: 300px; max-height: 300px; border-radius: 4px; margin-top:5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="col-users">
        <div class="section-header">
            <span>User Management</span>
            <i class="fas fa-users" style="color:#7f8c8d;"></i>
        </div>
        <div class="list-container" id="user-list">
            <div style="text-align:center; color:#666; margin-top:20px;">Waiting for data...</div>
        </div>
    </div>

    <div class="col-rooms">
        <div class="section-header">
            <span>Monitor Rooms</span>
            <i class="fas fa-desktop" style="color:#7f8c8d;"></i>
        </div>
        <div class="list-container" id="room-list"></div>
    </div>

    <div class="col-chat">
        <div class="section-header" id="chat-header">Global Chat</div>
        <div class="chat-container" id="chat-box"></div>
        <div class="input-area">
            <input type="text" id="admin-input" placeholder="Type message (@UID to whisper)..." onkeypress="if(event.key==='Enter') sendAdminMsg()">
            <button onclick="sendAdminMsg()">Send</button>
        </div>
    </div>

    <script>
        const socket = io();
        let currentRoomId = 'Global Chat';
        let chatLogs = {};
        const renderedFingerprints = new Set();

        socket.on('connect', () => {
            socket.emit('admin_join');
        });

        // --- 新增：监听用户列表更新 ---
        socket.on('admin_user_list_update', (users) => {
            renderUserList(users);
        });

        // 渲染用户列表
        function renderUserList(users) {
            const container = document.getElementById('user-list');
            container.innerHTML = '';

            // 排序：在线在前，离线在后
            users.sort((a, b) => {
                if (a.status === 'online' && b.status !== 'online') return -1;
                if (a.status !== 'online' && b.status === 'online') return 1;
                return 0;
            });

            users.forEach(u => {
                const isOnline = (u.status === 'online');
                const avatarSrc = u.avatar ? u.avatar : `https://ui-avatars.com/api/?name=${u.username}&background=random`;

                const card = document.createElement('div');
                card.className = 'user-card';
                card.innerHTML = `
                    <div class="uc-top">
                        <img src="${avatarSrc}" class="uc-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${u.username}'">
                        <div class="uc-info">
                            <div class="uc-name">
                                ${u.username}
                                <span class="status-dot ${isOnline ? 'status-online' : 'status-offline'}" title="${u.status}"></span>
                            </div>
                            <div class="uc-uid">UID: ${u.uid}</div>
                        </div>
                    </div>
                    <div class="uc-details">
                        <div class="uc-row">
                            <span>IP:</span> <span style="color:${isOnline?'#fff':'#888'}">${u.ip}</span>
                        </div>
                        <div class="uc-row">
                            <span>Last Seen:</span> <span style="color:#888">${isOnline ? 'Now' : u.last_seen}</span>
                        </div>
                    </div>
                `;
                // 点击用户卡片可以快速跳转到与该用户的私聊监控（可选功能）
                card.onclick = () => {
                   const roomKey = `ADMIN <-> ${u.uid}`;
                   if(!chatLogs[roomKey]) chatLogs[roomKey] = [];
                   switchRoom(roomKey);
                };
                container.appendChild(card);
            });
        }

        // --- 原有逻辑：房间列表与消息 ---

        socket.on('receive_message', (msg) => {
            let key = 'Global Chat';
            if (msg.target_uid && msg.target_uid !== 'global') {
                if (msg.uid === 'ADMIN' || msg.target_uid === 'ADMIN') {
                    const partner = (msg.uid === 'ADMIN') ? msg.target_uid : msg.uid;
                    key = `ADMIN <-> ${partner}`;
                } else {
                    const ids = [msg.uid, msg.target_uid].sort();
                    key = `${ids[0]} <-> ${ids[1]}`;
                }
            }
            if (!chatLogs[key]) chatLogs[key] = [];
            chatLogs[key].push(msg);
            renderRoomList();
            if (currentRoomId === key) renderMessages(key, false);
        });

        socket.on('admin_history_loaded', (data) => {
            const key = data.room_id;
            const msgs = data.messages;
            if (!chatLogs[key]) chatLogs[key] = msgs;
            else chatLogs[key] = msgs.concat(chatLogs[key]);
            if (currentRoomId === key) renderMessages(key, true);
        });

        socket.on('admin_history_load', (msgs) => {
            chatLogs['Global Chat'] = msgs;
            if (currentRoomId === 'Global Chat') renderMessages('Global Chat', true);
        });

        function renderRoomList() {
            const list = document.getElementById('room-list');
            list.innerHTML = '';
            addCard(list, 'Global Chat', 'Global Chat');
            for (let key in chatLogs) {
                if (key === 'Global Chat') continue;
                addCard(list, key, key);
            }
        }

        function addCard(parent, name, id) {
            const div = document.createElement('div');
            div.className = `room-card ${currentRoomId === id ? 'active' : ''}`;
            div.onclick = () => switchRoom(id);
            div.innerHTML = `<div class="room-title">${name}</div>`;
            parent.appendChild(div);
        }

        function switchRoom(id) {
            currentRoomId = id;
            document.getElementById('chat-header').innerText = id;
            renderRoomList();
            if (!chatLogs[id] || chatLogs[id].length < 1) socket.emit('admin_request_history', { room_id: id });
            renderMessages(id, true);
        }

        function renderMessages(key, clearMode = false) {
            const box = document.getElementById('chat-box');
            const msgs = chatLogs[key] || [];
            if (clearMode) {
                box.innerHTML = '';
                renderedFingerprints.clear();
            }
            let hasNew = false;

            msgs.forEach(msg => {
                const fingerprint = `${msg.uid}-${msg.timestamp}-${msg.content}`;
                if (renderedFingerprints.has(fingerprint)) return;
                renderedFingerprints.add(fingerprint);
                hasNew = true;

                const div = document.createElement('div');
                div.className = 'msg-row';
                let content = msg.content;
                // 简单的图片/视频渲染处理
                if(msg.type === 'image') content = `<img src="${msg.content}" class="media-preview" onclick="window.open(this.src)">`;
                else if(msg.type === 'video') content = `<video src="${msg.content}" class="media-preview" controls></video>`;

                div.innerHTML = `
                    <div class="msg-meta">${msg.timestamp} - ${msg.sender} (${msg.uid})</div>
                    <div class="msg-content">${content}</div>
                `;
                box.appendChild(div);
            });
            if (hasNew || clearMode) box.scrollTop = box.scrollHeight;
        }

        function sendAdminMsg() {
            const input = document.getElementById('admin-input');
            const rawText = input.value.trim();
            if (!rawText) return;

            let target = null;
            let contentToSend = rawText;
            const match = rawText.match(/^@(\w+)\s+(.+)/);

            if (match) {
                target = match[1];
                contentToSend = match[2];
            } else {
                if (currentRoomId === 'Global Chat') target = 'global';
                else if (currentRoomId.includes('<->')) {
                    const parts = currentRoomId.split(' <-> ');
                    if (parts[0] === 'ADMIN') target = parts[1];
                    else if (parts[1] === 'ADMIN') target = parts[0];
                    else { alert("In user-to-user chat view, please use @UID to whisper."); return; }
                }
            }
            if (target && contentToSend) {
                socket.emit('admin_send_message', { target_uid: target, content: contentToSend });
                input.value = '';
            }
        }
    </script>
</body>
</html>