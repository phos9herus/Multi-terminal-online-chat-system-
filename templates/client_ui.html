<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Client</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    :root {
        --primary-color: #0084ff;
        --bg-gray: #f0f2f5;
        --sidebar-bg: #ffffff;
        --text-main: #1c1e21;
        --text-muted: #65676b;
        --msg-bubble-self: #0084ff;
        --msg-bubble-other: #e4e6eb;
        --error-red: #e74c3c;
        --unread-red: #ff3b30;
    }

    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-gray); margin: 0; overflow: hidden; color: var(--text-main); }

    .app-container { display: none; width: 100vw; height: 100vh; background: white; overflow: hidden; }

    /* Sidebar Layout */
    .sidebar { width: 320px; background: var(--sidebar-bg); border-right: 1px solid #ddd; display: flex; flex-direction: column; z-index: 10; height: 100vh; }
    .sidebar-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; height: 60px; box-sizing: border-box; }
    .sidebar-header h2 { font-size: 1.5rem; margin: 0; color: var(--primary-color); }

    .user-profile-bar { padding: 15px; background: #f9f9f9; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
    .my-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #ddd; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .my-info { flex: 1; overflow: hidden; }
    .my-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .my-uid { font-size: 0.75rem; color: #888; }

    /* äº’åŠ¨ä¸å¼•ç”¨æ ·å¼ */
    .msg-bubble-container { position: relative; display: flex; flex-direction: column; }

    /* èœå•æ ·å¼ */
    .reaction-menu {
        position: absolute;
        /* å‚ç›´å±…ä¸­ */
        top: 50%;
        transform: translateY(-50%);
        /* ä½äºæ°”æ³¡å³ä¾§ */
        left: 100%;
        margin-left: 10px; /* ä¸æ°”æ³¡çš„é—´è· */

        background: white;
        padding: 4px 8px;
        border-radius: 50px; /* æ›´åœ†æ¶¦ */
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        border: 1px solid #eee;

        display: none;
        align-items: center;
        gap: 8px;
        z-index: 100;

        /* ç®€å•çš„æ·¡å…¥åŠ¨ç”» */
        opacity: 0;
        transition: opacity 0.2s;
    }
    .reaction-menu.show {
        display: flex;
        opacity: 1;
    }

    .menu-btn {
        width: 32px; height: 32px; border-radius: 50%; border: none; background: transparent;
        cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center;
        transition: 0.2s;
    }
    .menu-btn:hover { background: #f0f2f5; transform: scale(1.1); }
    .menu-btn.quote-btn { color: var(--primary-color); }

    /* äº’åŠ¨ç»Ÿè®¡æ¡ */
    .reaction-bar { display: flex; gap: 5px; margin-top: 4px; padding-left: 5px; }
    .reaction-pill {
        background: #fff; border: 1px solid #e4e6eb; border-radius: 12px;
        padding: 2px 8px; font-size: 0.75rem; color: #555;
        display: flex; align-items: center; gap: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    /* å¼•ç”¨é¢„è§ˆæ‚¬æµ®æ¡† (åœ¨è¾“å…¥æ¡†ä¸Šæ–¹) */
    .quote-preview-bar {
        display: none; /* JSæ§åˆ¶æ˜¾ç¤º */
        position: absolute;

        /* å…³é”®ï¼šä½äºè¾“å…¥æ¡†æ­£ä¸Šæ–¹ */
        bottom: 100%;
        left: 0;
        right: 0;

        background: rgba(249, 249, 249, 0.98);
        backdrop-filter: blur(10px);
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #eee;
        padding: 12px 20px;
        z-index: 50;
        border-left: 5px solid var(--primary-color);
        box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
    }
    .quote-preview-content { flex: 1; font-size: 0.9rem; color: #444; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .quote-close-btn { background: none; border: none; cursor: pointer; color: #999; font-size: 1.2rem; margin-left: 10px; }
    .quote-close-btn:hover { color: var(--error-red); }

    /* æ¶ˆæ¯å†…çš„åµŒå…¥å¼•ç”¨ */
    .embedded-quote {
        background: #f7f7f7; border-left: 3px solid #ccc; border-radius: 4px;
        padding: 8px 10px; margin-bottom: 5px; cursor: pointer; position: relative;
        font-size: 0.85rem; color: #666; transition: 0.2s;
    }
    .embedded-quote:hover { background: #eee; border-left-color: var(--primary-color); }
    .quote-sender { font-weight: bold; font-size: 0.75rem; margin-bottom: 2px; color: #333; }

    /* åªæœ‰åˆ«äººçš„æ°”æ³¡æ‰å…è®¸ç‚¹å‡» */
    .message-row.other .msg-bubble { cursor: pointer; transition: 0.2s; }
    .message-row.other .msg-bubble:hover { filter: brightness(0.97); }

    /* Chat Tabs List */
    .chat-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }

    /* Sidebar Tab Item Style */
    .tab-item { padding: 12px 16px; display: flex; align-items: center; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; position: relative; height: 72px; box-sizing: border-box; }
    .tab-item:hover { background: #f5f6f7; }
    .tab-item.active { background: #e7f3ff; border-left-color: var(--primary-color); }

    .tab-avatar-container { position: relative; margin-right: 12px; }
    .tab-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }

    /* Unread Dot */
    .unread-dot {
        position: absolute; top: -2px; right: -2px; width: 12px; height: 12px;
        background: var(--unread-red); border-radius: 50%; border: 2px solid white;
        display: none; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .tab-item.unread .unread-dot { display: block; }

    .tab-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
    .tab-top { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; }
    .tab-name { font-weight: 600; font-size: 0.95rem; color: #050505; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
    .tab-time { font-size: 0.75rem; color: #bcc0c4; white-space: nowrap; margin-left: 5px; }

    .tab-preview {
        font-size: 0.85rem; color: var(--text-muted);
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .tab-item.unread .tab-preview { font-weight: 600; color: #050505; }

    /* Friends Menu Button */
    .friends-menu-btn {
        padding: 15px; border-top: 1px solid #eee; background: #fff; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        font-weight: 600; color: #555; transition: background 0.2s;
    }
    .friends-menu-btn:hover { background: #f0f2f5; color: var(--primary-color); }

    /* Chat Area */
    .chat-area { flex: 1; display: flex; flex-direction: column; background: white; height: 100vh; }
    .chat-header { height: 60px; padding: 0 25px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .chat-header .title { font-weight: bold; font-size: 1.1rem; }
    .status-indicator { color:#2ecc71; font-size:0.8rem; display:flex; align-items:center; gap:5px; }

    .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #ffffff; }

    /* Messages */
    .message-row { display: flex; align-items: flex-start; width: 100%; animation: slideIn 0.2s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message-row.self { flex-direction: row-reverse; }
    .chat-avatar { width: 36px; height: 36px; border-radius: 50%; margin: 0 8px; object-fit: cover; flex-shrink: 0; border: 1px solid #eee; cursor: pointer; }
    .chat-avatar:hover { transform: scale(1.05); }

    .msg-content-group { display: flex; flex-direction: column; max-width: 65%; }
    .message-row.self .msg-content-group { align-items: flex-end; }
    .msg-timestamp { font-size: 0.7rem; color: #bcc0c4; margin-bottom: 4px; padding: 0 4px; }

    .msg-bubble { padding: 10px 16px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; }
    .message-row.other .msg-bubble { background: var(--msg-bubble-other); color: black; border-top-left-radius: 4px; }
    .message-row.self .msg-bubble { background: var(--msg-bubble-self); color: white; border-top-right-radius: 4px; }
    .chat-media { border-radius: 12px; max-width: 100%; max-height: 350px; cursor: pointer; border: 1px solid #eee; display: block; }

    /* Input Area */
    .input-area {
        /* å…³é”®ï¼šå¿…é¡»æ˜¯ relativeï¼Œå¦åˆ™å†…éƒ¨ç»å¯¹å®šä½çš„å¼•ç”¨æ¡†ä¼šè·‘åˆ°å±å¹•å¤–é¢å» */
        position: relative;
        padding: 15px 20px;
        border-top: 1px solid #eee;
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
        background: white; /* ç¡®ä¿èƒŒæ™¯ä¸é€æ˜ */
        z-index: 20; /* æé«˜å±‚çº§ */
    }
    .msg-input { flex: 1; background: #f0f2f5; border: none; padding: 12px 20px; border-radius: 20px; outline: none; font-size: 15px; }
    .icon-btn { background: none; border: none; color: var(--primary-color); font-size: 1.4rem; cursor: pointer; }

    .upload-progress-container { width: 200px; padding: 10px; background: #fff; border: 1px solid var(--primary-color); border-radius: 8px; margin-top: 5px; }
    progress { width: 100%; height: 6px; border-radius: 3px; }

    /* Modals & Overlays */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(2px); align-items: center; justify-content: center; }
    .modal-box { background: white; border-radius: 12px; padding: 30px; width: 350px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: popIn 0.2s ease; max-height: 80vh; overflow-y: auto; }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    /* Auth Styles & Background Animation */
    #auth-overlay {
        position: fixed; inset: 0;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        z-index: 2000;
        display: flex; justify-content: center; align-items: center;
        overflow: hidden;
    }

    /* ç™»å½•æ¡†æ¯›ç»ç’ƒç‰¹æ•ˆ */
    #auth-overlay .modal-box {
        background: rgba(255, 255, 255, 0.65);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        z-index: 10;
        position: relative;
    }

        .breathing-halo {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        margin: 0 auto 20px auto;
        display: flex;
        justify-content: center;
        align-items: center;

        /* åˆå§‹çŠ¶æ€ï¼šè“è‰²å‘¼å¸è¾¹æ¡† */
        border: 3px solid var(--primary-color);
        background: white;
        color: var(--primary-color);
        font-size: 2.5rem;

        /* å‘¼å¸åŠ¨ç”» */
        animation: halo-breathe 2.5s infinite ease-in-out;
        box-shadow: 0 0 20px rgba(0, 132, 255, 0.3);
        overflow: hidden; /* ç¡®ä¿å¤´åƒå›¾ç‰‡ä¹Ÿæ˜¯åœ†çš„ */
        transition: all 0.3s ease;
    }

    @keyframes halo-breathe {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 132, 255, 0.4); }
        50% { transform: scale(1.05); box-shadow: 0 0 25px 10px rgba(0, 132, 255, 0.1); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 132, 255, 0.4); }
    }

    /* å¤´åƒå›¾ç‰‡æ ·å¼ */
    .breathing-halo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        animation: none; /* å›¾ç‰‡æœ¬èº«ä¸ç¼©æ”¾ï¼Œè·Ÿéšå®¹å™¨å³å¯ */
    }


    .auth-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    .btn-full { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .btn-danger { background: #fff; color: var(--error-red); border: 1px solid var(--error-red); margin-top: 20px; }
    .btn-danger:hover { background: #fff5f5; }

    /* åŠ¨æ€å…‰æ™•æ•ˆæœ */
    .orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(10px); /* ä¿æŒé«˜æ–¯æ¨¡ç³Š */
    opacity: 0.6;       /*ç¨å¾®é™ä½ä¸€ç‚¹é€æ˜åº¦ï¼Œå› ä¸ºé‡å å¯èƒ½å˜å¤š*/
    z-index: 1;         /* ç¡®ä¿åœ¨ç™»å½•æ¡†ä¸‹é¢ */
    animation: float-orb infinite ease-in-out alternate;
    pointer-events: none; /* é˜²æ­¢å…‰æ™•æŒ¡ä½ç‚¹å‡»äº‹ä»¶ */
    }

    @keyframes float-orb {
        0% { transform: translate(0, 0) scale(1); }
        33% { transform: translate(60px, 80px) scale(1.2); }
        66% { transform: translate(-20px, 30px) scale(0.9); }
        100% { transform: translate(50px, -30px) scale(1.05); }
    }

    /* User Card */
    .uc-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
    .uc-avatar { width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 3px solid #f0f2f5; }
    .uc-info { display: flex; flex-direction: column; }
    .uc-username { font-weight: bold; font-size: 1.1rem; }
    .uc-uid { font-size: 0.85rem; color: #888; background: #f0f2f5; padding: 2px 6px; border-radius: 4px; display: inline-block; align-self: flex-start; }
    .uc-actions { display: flex; gap: 10px; }
    .uc-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 5px; }

    /* Friend Item & Menu */
    .friend-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; position: relative; }
    .friend-item:hover { background: #f9f9f9; }
    .friend-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; border: 1px solid #eee; object-fit: cover;}

    .friend-actions { position: relative; margin-left: auto; }
    .friend-menu-btn { background: none; border: none; cursor: pointer; color: #999; padding: 5px 10px; font-size: 1.1rem; }
    .friend-menu-btn:hover { color: var(--primary-color); }
    .friend-dropdown { display: none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 100; min-width: 80px; }
    .friend-dropdown.show { display: block; }
    .friend-dropdown-item { padding: 8px 12px; font-size: 0.85rem; color: #333; cursor: pointer; white-space: nowrap; }
    .friend-dropdown-item:hover { background: #f5f5f5; color: var(--error-red); }

    /* Settings specific */
    .avatar-upload-container { display: flex; justify-content: center; margin-bottom: 25px; }
    .avatar-preview-wrapper { width: 90px; height: 90px; border-radius: 50%; margin: 0 auto 20px; overflow: hidden; cursor: pointer; border: 3px solid #f0f2f5; position: relative; }
    .avatar-preview-img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; color: white; opacity: 0; transition: 0.2s; font-size: 1.5rem; }
    .avatar-preview-wrapper:hover .avatar-overlay { opacity: 1; }

    .settings-section { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
    .switch-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-size: 0.9rem; color: #333; }
    .toggle-checkbox { transform: scale(1.2); }

    #notification-bar { position: fixed; top: -80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 25px; border-radius: 50px; transition: top 0.4s; z-index: 3000; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    #notification-bar.show { top: 25px; }
</style>
</head>
<body>
    <div id="notification-bar"><span id="notify-content"></span></div>

    <div id="auth-overlay">


        <div class="modal-box" style="text-align:center;">
            <div id="login-halo" class="breathing-halo">
                <i class="fas fa-comments"></i>
            </div>
            <div id="login-status-indicator" style="margin-bottom: 20px; font-size: 0.85rem; font-weight: bold; color: #f39c12;">
                <i class="fas fa-circle-notch fa-spin"></i> Connecting to Server...
            </div>
            <p style="color:#666; font-size:0.9rem; margin-bottom:25px;">Secure Terminal Login</p>
            <input type="text" id="username" class="auth-input" placeholder="Username / UID">
            <input type="password" id="password" class="auth-input" placeholder="Password">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="code" class="auth-input" placeholder="Code" style="margin-bottom:0; text-align:center;">
                <button onclick="requestCode()" style="padding:0 15px; background:#e7f3ff; color:var(--primary-color); border:1px solid var(--primary-color); border-radius:8px; cursor:pointer; font-weight:600;">Get Code</button>
            </div>
            <button class="btn-full" onclick="doLogin()">Enter Chat</button>
        </div>
    </div>

    <div class="app-container" id="app">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Chats</h2>
                <i class="fas fa-cog" style="cursor:pointer; color:#888; font-size:1.1rem;" onclick="openSettings()"></i>
            </div>
            <div class="user-profile-bar">
                <img id="my-avatar-img" class="my-avatar" src="" onerror="this.src='https://ui-avatars.com/api/?name=Me'" onclick="openSettings()">
                <div class="my-info">
                    <div id="my-name-display" class="my-name">Guest</div>
                    <div id="my-uid-display" class="my-uid">UID: ---</div>
                </div>
            </div>

            <div class="chat-list" id="chat-tabs-container">
                </div>

            <div class="friends-menu-btn" onclick="openFriendsModal()">
                <i class="fas fa-user-friends"></i> Friends Menu
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <div class="title" id="current-chat-title">Global Chat Room</div>
                <div class="status-indicator"><i class="fas fa-circle" style="font-size:0.6rem;"></i> Online</div>
            </div>
            <div class="messages" id="msg-list"></div>
            <div class="input-area">
                <div id="quote-preview-bar" class="quote-preview-bar">
                    <div style="display:flex; flex-direction:column; overflow:hidden; flex:1;">
                        <span style="font-weight:bold; font-size:0.75rem; color:var(--primary-color); margin-bottom:2px;">
                            <i class="fas fa-reply"></i> Replying to <span id="quote-preview-sender">User</span>
                        </span>
                        <span id="quote-preview-text" class="quote-preview-content">...</span>
                    </div>
                    <button class="quote-close-btn" onclick="cancelQuote()"><i class="fas fa-times-circle"></i></button>
                </div>

                <button class="icon-btn" onclick="document.getElementById('media-upload').click()"><i class="fas fa-plus-circle"></i></button>
                <input type="file" id="media-upload" hidden accept="image/*,video/*" onchange="handleMediaUpload(this)">
                <input type="text" class="msg-input" id="msg-text" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMsg()">
                <button class="icon-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="user-card-overlay" onclick="closeUserCard()" style="display:none;">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="uc-header">
                <img id="uc-avatar" class="uc-avatar" src="">
                <div class="uc-info">
                    <div id="uc-username" class="uc-username">Username</div>
                    <div id="uc-uid" class="uc-uid">UID: ---</div>
                </div>
            </div>
            <div class="uc-actions">
                <button class="uc-btn" style="background:#e4e6eb; color:#000;" onclick="addFriendAction()"><i class="fas fa-user-plus"></i> Add Friend</button>
                <button class="uc-btn" style="background:var(--primary-color); color:#fff;" onclick="startPrivateChatFromCard()"><i class="fas fa-comment-dots"></i> Message</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="friends-modal" onclick="closeFriendsModal()" style="display:none;">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 style="margin-top:0;">My Friends</h3>
            <div id="friends-list-container" style="max-height: 300px; overflow-y:auto;">
                <p style="color:#999; text-align:center;">Loading...</p>
            </div>
            <button class="btn-full" style="margin-top:15px; background:#eee; color:#333;" onclick="closeFriendsModal()">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal" onclick="closeSettings()" style="display:none;">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 style="margin-top:0; text-align:center;">Settings</h3>

            <div class="avatar-upload-container">
                <div class="avatar-preview-wrapper" onclick="document.getElementById('st-avatar-input').click()">
                    <img id="settings-avatar-preview" class="avatar-preview-img" src="">
                    <div class="avatar-overlay"><i class="fas fa-camera"></i></div>
                </div>
                <input type="file" id="st-avatar-input" accept="image/*" hidden onchange="uploadAvatarImmediately(this)">
            </div>

            <input type="text" id="st-username" class="auth-input" placeholder="New Username">

            <input type="password" id="st-password" class="auth-input" placeholder="New Password" oninput="checkPasswordInput()">

            <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 5px; margin-top: 10px;">Chat History Limit (Default: 128)</label>
            <input type="number" id="st-history-limit" class="auth-input" placeholder="128" value="128">

            <div style="border-top: 1px solid #eee; margin: 15px 0; padding-top: 15px;">
                <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 5px;">Verification Code (For Password Change)</label>

                <input type="text" id="st-code" class="auth-input" placeholder="Enter Code">

                <button id="btn-settings-code" onclick="requestCode()" class="btn-full"
                    style="margin-bottom: 10px; background:#e7f3ff; color:var(--primary-color); border: 1px solid var(--primary-color);" disabled>
                    Get Verification Code
                </button>
            </div>

            <div id="st-error-msg" style="color:red; font-size:12px; margin-bottom:10px; display:none;">Need code to change password</div>

            <button class="btn-full" onclick="saveProfile()" style="background:#2ecc71;">Save Changes</button>

            <button class="btn-full btn-danger" onclick="doLogout()">Logout</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const SERVER_URL = "{{ server_url }}";
        const socket = io(SERVER_URL);

        let myInfo = { username: '', uid: '', avatar: '' };
        let currentTarget = 'global';

        let reactionDataCache = {};

        // Unread tracking
        let lastReadMap = {};

        const renderedFingerprints = new Set();

        // Friends Data
        let friendsList = [];

        // Temp storage for user card
        let currentCardUser = {};

        socket.on('connect', () => console.log("[Socket] Connected"));

        socket.on('history_loaded', (data) => {
            // data ç»“æ„: { messages: [], target_uid: '...' }

            // åªæœ‰å½“è¿”å›çš„æ•°æ®å±äºå½“å‰æ­£åœ¨æŸ¥çœ‹çš„èŠå¤©å¯¹è±¡æ—¶ï¼Œæ‰æ¸²æŸ“
            // æ³¨æ„ï¼šdata.target_uid å¯èƒ½æ˜¯ 'global' æˆ– å…·ä½“çš„ UID
            // currentTarget ä¹Ÿæ˜¯ 'global' æˆ– å…·ä½“çš„ UID

            if (data.target_uid === currentTarget || (data.target_uid === 'global' && currentTarget === 'global')) {
                // ä½¿ç”¨ true å¼€å¯æ¸…é™¤æ¨¡å¼ (Clear Mode)ï¼Œå› ä¸ºè¿™æ˜¯åŠ è½½å†å²è®°å½•ï¼Œéœ€è¦æ›¿æ¢å½“å‰å±å¹•å†…å®¹
                renderMessages(data.messages, false);
            }
        });

        // Helper: Parse server timestamp "YYYY-MM-DD HH:MM:SS" to milliseconds
        function parseTimestamp(tsStr) {
            if (!tsStr) return 0;
            // Replace space with T to make it ISO-like for some browsers
            // Safest cross-browser way is standard JS Date parse if format is standard
            return new Date(tsStr.replace(' ', 'T')).getTime();
        }

        // --- Main Polling Loop ---
        setInterval(() => {
            fetch('/api/status').then(r => r.json()).then(d => {

                // =======================================================
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ›´æ–°å…¨å±€è¿æ¥çŠ¶æ€å˜é‡
                // è¿™è®©åº•éƒ¨çš„è¾“å…¥æ¡†ç›‘å¬å™¨çŸ¥é“ç°åœ¨æ˜¯å¦å¯ä»¥å‘é€å¤´åƒæ£€æŸ¥è¯·æ±‚
                // =======================================================
                if (d.connection_status === 'Connected') {
                    isServerConnected = true;
                } else {
                    isServerConnected = false;
                }
                // =======================================================

                const statusLabel = document.getElementById('login-status-indicator');
                const loginBtn = document.querySelector('#auth-overlay .btn-full'); // è·å–ç™»å½•æŒ‰é’®

                if (statusLabel) {
                    if (d.connection_status === 'Connected') {
                        statusLabel.innerHTML = '<i class="fas fa-check-circle"></i> Server Connected';
                        statusLabel.style.color = '#2ecc71'; // ç»¿è‰²
                        if(loginBtn) loginBtn.disabled = false;
                        if(loginBtn) loginBtn.style.opacity = "1";
                    } else {
                        statusLabel.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Connecting...';
                        statusLabel.style.color = '#e74c3c'; // çº¢è‰²
                        // æœªè¿æ¥æ—¶ç¦ç”¨ç™»å½•æŒ‰é’®é˜²æ­¢è¯¯è§¦
                        if(loginBtn) loginBtn.disabled = true;
                        if(loginBtn) loginBtn.style.opacity = "0.6";
                    }
                }

                if (d.verified) {
                    // Auth Check
                    if (document.getElementById('auth-overlay').style.display !== 'none') {
                        // Init Session
                        myInfo = { username: d.username, uid: d.uid, avatar: d.avatar };
                        document.getElementById('auth-overlay').style.display = 'none';
                        document.getElementById('app').style.display = 'flex';

                        document.getElementById('my-name-display').innerText = d.username;
                        document.getElementById('my-uid-display').innerText = "UID: " + d.uid;
                        if(d.avatar) document.getElementById('my-avatar-img').src = SERVER_URL + d.avatar;

                        // Load Friends
                        fetchFriends();

                        switchChat('global', 'Global Chat Room');
                    } else if (myInfo.username !== d.username) {
                        myInfo.username = d.username;
                        document.getElementById('my-name-display').innerText = d.username;
                    }

                    if (d.messages) {
                        processDataAndRender(d.messages);
                    }
                }

                if (d.notification) {
                    const codeMatch = d.notification.match(/Verification Code:\s*(\d{6})/);
                    if (codeMatch) {
                         const code = codeMatch[1];
                         const inputs = [document.getElementById('code'), document.getElementById('st-code')];
                         inputs.forEach(i => { if(i) i.value = code; });
                    }
                    if(d.notification !== "Media sent!") showNotification(d.notification);
                    fetch('/api/clear_notification', { method: 'POST' });
                }
            });
        }, 800);

        // --- Core Logic ---
        function processDataAndRender(messages) {
            let conversations = {};
            // ... (Sidebar æ„å»ºé€»è¾‘ä¿æŒä¸å˜) ...
            conversations['global'] = {
                uid: 'global', username: 'Global Chat Room', avatar: '', lastMsg: null, unread: false
            };

            messages.forEach(m => {
               // ... (Sidebar å¤„ç†é€»è¾‘ä¿æŒä¸å˜) ...
               let key = null;
               if (!m.target_uid || m.target_uid === 'global') key = 'global';
               else if (m.uid === myInfo.uid) key = m.target_uid;
               else if (m.target_uid === myInfo.uid) key = m.uid;

               if (key) {
                   if (!conversations[key]) {
                        const friend = friendsList.find(f => f.uid === key);
                        const partnerName = friend ? friend.username : ((m.uid === myInfo.uid) ? 'User ' + key : m.sender);
                        conversations[key] = { uid: key, username: partnerName, avatar: null, lastMsg: null, unread: false };
                   }
                   conversations[key].lastMsg = m;
                   if (key !== 'global' && m.uid === key) conversations[key].username = m.sender;

                   // Unread Check
                   if (key !== 'global' && m.uid !== myInfo.uid && currentTarget !== key) {
                         const msgTime = parseTimestamp(m.timestamp);
                         const lastReadTime = lastReadMap[key] || 0;
                         if (msgTime > lastReadTime) conversations[key].unread = true;
                   }
               }
            });

            // Sidebar fallback (keeping existing logic)
            if (currentTarget !== 'global' && !conversations[currentTarget]) {
                const friend = friendsList.find(f => f.uid === currentTarget);
                conversations[currentTarget] = {
                    uid: currentTarget,
                    username: friend ? friend.username : ('User ' + currentTarget),
                    avatar: null, lastMsg: null, unread: false
                };
            }
            renderSidebar(conversations);

            // --- ä¿®æ”¹é‡ç‚¹ï¼šå¤„ç†å½“å‰èŠå¤©çª—å£çš„æ¶ˆæ¯ ---
            const relevantMsgs = messages.filter(m => {
                if (currentTarget === 'global') return !m.target_uid || m.target_uid === 'global';
                return (m.uid === myInfo.uid && m.target_uid === currentTarget) ||
                       (m.uid === currentTarget && m.target_uid === myInfo.uid);
            });

            // ä¸å†æ¯”è¾ƒ lengthï¼Œç›´æ¥ä¼ å…¥è¿½åŠ æ¸²æŸ“ (false = append mode)
            // renderMessages å†…éƒ¨ä¼šæ ¹æ®æŒ‡çº¹å»é‡ï¼Œå¦‚æœæ¶ˆæ¯å·²åœ¨å†å²è®°å½•é‡Œï¼Œåˆ™ä¸ä¼šé‡å¤æ¸²æŸ“
            if (relevantMsgs.length > 0) {
                renderMessages(relevantMsgs, false);
            }
        }

        function renderSidebar(convs) {
            const container = document.getElementById('chat-tabs-container');

            // 1. æ’åºé€»è¾‘ (ä¿æŒä¸å˜)
            const sortedKeys = Object.keys(convs).sort((a, b) => {
                // Global å§‹ç»ˆç½®é¡¶
                if (a === 'global') return -1;
                if (b === 'global') return 1;
                // å…¶æ¬¡æ˜¯ Admin (å¦‚æœä½ å¸Œæœ› Admin åœ¨ Global ä¹‹åï¼Œå…¶ä»–ä¹‹å‰)
                if (a === 'ADMIN') return -1;
                if (b === 'ADMIN') return 1;

                const timeA = convs[a].lastMsg ? convs[a].lastMsg.timestamp : '';
                const timeB = convs[b].lastMsg ? convs[b].lastMsg.timestamp : '';
                return timeB.localeCompare(timeA);
            });

            const validIds = new Set();

            sortedKeys.forEach(key => {
                const c = convs[key];
                const isActive = (key === currentTarget);
                const isGlobal = (key === 'global');

                // 2. å‡†å¤‡æ•°æ®
                let preview = "No messages";
                let timeStr = "";
                if (c.lastMsg) {
                    if (c.lastMsg.type === 'image') preview = "[Image]";
                    else if (c.lastMsg.type === 'video') preview = "[Video]";
                    else preview = c.lastMsg.content.substring(0, 15) + (c.lastMsg.content.length>15 ? "..." : "");

                    if (c.lastMsg.timestamp) {
                        const parts = c.lastMsg.timestamp.split(' ');
                        if(parts.length > 1) {
                            const timeParts = parts[1].split(':');
                            timeStr = `${timeParts[0]}:${timeParts[1]}`;
                        }
                    }
                } else if (key === 'ADMIN') {
                     // Admin å¦‚æœæ²¡æœ‰æ¶ˆæ¯æ—¶çš„é»˜è®¤æ–‡æ¡ˆ
                     preview = "System Administrator";
                }

                // 3. ç”Ÿæˆ/æŸ¥æ‰¾ DOM å…ƒç´ çš„ ID
                // æ³¨æ„ï¼šHTML id ä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œå¦‚æœ uid æ¯”è¾ƒå¤æ‚å¯èƒ½éœ€è¦å¤„ç†ï¼Œè¿™é‡Œå‡è®¾ uid æ˜¯å®‰å…¨çš„
                const domId = `tab-item-${c.uid}`;
                validIds.add(domId);

                let div = document.getElementById(domId);

                if (div) {
                    // --- A. å¦‚æœå…ƒç´ å·²å­˜åœ¨ï¼šåªæ›´æ–°å˜åŠ¨çš„éƒ¨åˆ† (é˜²é—ªçƒæ ¸å¿ƒ) ---

                    // æ›´æ–° Class (æ¿€æ´»/æœªè¯»)
                    const targetClass = `tab-item ${isActive ? 'active' : ''} ${c.unread ? 'unread' : ''}`;
                    if (div.className !== targetClass) {
                        div.className = targetClass;
                    }

                    // æ›´æ–°é¢„è§ˆæ–‡æœ¬
                    const previewEl = div.querySelector('.tab-preview');
                    if (previewEl.innerText !== preview) previewEl.innerText = preview;

                    // æ›´æ–°æ—¶é—´
                    const timeEl = div.querySelector('.tab-time');
                    if (timeEl.innerText !== timeStr) timeEl.innerText = timeStr;

                    // æ›´æ–°åå­— (é˜²æ­¢æ”¹ååä¸åˆ·æ–°)
                    const nameEl = div.querySelector('.tab-name');
                    if (nameEl.innerText !== c.username) nameEl.innerText = c.username;

                    // å…³é”®ï¼šappendChild ä¸€ä¸ªå·²å­˜åœ¨çš„å…ƒç´ ï¼Œä¼šå°†å…¶ç§»åŠ¨åˆ°å®¹å™¨çš„æœ€åé¢
                    // é…åˆ sortedKeys çš„å¾ªç¯é¡ºåºï¼Œå®ç°äº†è‡ªåŠ¨æ’åºä¸”ä¸é‡å»º DOM
                    container.appendChild(div);

                } else {
                    // --- B. å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼šåˆ›å»ºå…¨æ–°çš„ DOM ---
                    div = document.createElement('div');
                    div.id = domId;
                    div.className = `tab-item ${isActive ? 'active' : ''} ${c.unread ? 'unread' : ''}`;
                    div.onclick = () => switchChat(c.uid, c.username);

                    let avaSrc = "";
                    if (isGlobal) {
                        avaSrc = "https://ui-avatars.com/api/?name=Global&background=0084ff&color=fff";
                    } else if (c.uid === 'ADMIN') {
                        avaSrc = "https://ui-avatars.com/api/?name=Admin&background=000&color=fff";
                    } else {
                        avaSrc = `${SERVER_URL}/api/avatar/${c.uid}`;
                    }

                    div.innerHTML = `
                        <div class="tab-avatar-container">
                            <img src="${avaSrc}" class="tab-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${c.username}'">
                            <div class="unread-dot"></div>
                        </div>
                        <div class="tab-content">
                            <div class="tab-top">
                                <span class="tab-name">${c.username}</span>
                                <span class="tab-time">${timeStr}</span>
                            </div>
                            <div class="tab-preview">${preview}</div>
                        </div>
                    `;
                    container.appendChild(div);
                }
            });

            // 4. æ¸…ç†é€»è¾‘ï¼šç§»é™¤é‚£äº›ä¸åœ¨æ–°åˆ—è¡¨é‡Œçš„æ—§ Tab (ä¾‹å¦‚è¢«åˆ é™¤äº†å¥½å‹)
            // å¿…é¡»è½¬ä¸º Array æ‰èƒ½åœ¨éå†æ—¶å®‰å…¨åˆ é™¤
            Array.from(container.children).forEach(child => {
                if (!validIds.has(child.id)) {
                    container.removeChild(child);
                }
            });
        }

        // --- å…¨å±€å˜é‡ ---
        let currentQuote = null; // å­˜å‚¨å½“å‰æ­£åœ¨å¼•ç”¨çš„æ¶ˆæ¯å¯¹è±¡

        socket.on('reaction_update', (data) => {
            // data: { msg_id: '...', reactions: {...} }
            // æ›´æ–°ç¼“å­˜ï¼Œä»¥æœåŠ¡ç«¯ä¸ºå‡†
            reactionDataCache[data.msg_id] = data.reactions;
            updateMessageReactions(data.msg_id, data.reactions);
        });

        // æ¸²æŸ“æ¶ˆæ¯ (æ”¯æŒå¼•ç”¨ã€èœå•ã€äº’åŠ¨æ¡)

        function renderMessages(msgs, clearMode = false) {
            const list = document.getElementById('msg-list');

            // æ¸…é™¤æ¨¡å¼ï¼šä¿å­˜ä¸Šä¼ è¿›åº¦æ¡ï¼Œæ¸…ç©ºåˆ—è¡¨
            let tempUploads = [];
            if (clearMode) {
                list.querySelectorAll('[id^="t_"]').forEach(el => tempUploads.push(el));
                list.innerHTML = '';
                renderedFingerprints.clear();
            }

            let hasNewContent = false;
            const hideAdminGlobal = localStorage.getItem('hide_admin_global') === 'true';

            msgs.forEach(msg => {
                // è¿‡æ»¤é€»è¾‘
                if (currentTarget === 'global' && msg.uid === 'ADMIN' && hideAdminGlobal) {
                    return;
                }

                // æŒ‡çº¹å»é‡
                const msgFingerprint = `${msg.uid}-${msg.timestamp}-${msg.content}`;
                if (renderedFingerprints.has(msgFingerprint)) return;
                renderedFingerprints.add(msgFingerprint);
                hasNewContent = true;

                // åŒæ­¥äº’åŠ¨ç¼“å­˜
                if (msg.reactions) {
                    reactionDataCache[msg.id] = msg.reactions;
                } else if (!reactionDataCache[msg.id]) {
                    reactionDataCache[msg.id] = {};
                }

                // åŸºç¡€å˜é‡
                const isSelf = (msg.uid === myInfo.uid);
                const row = document.createElement('div');
                row.className = `message-row ${isSelf ? 'self' : 'other'}`;
                // ä½¿ç”¨æœåŠ¡ç«¯ ID ä½œä¸º DOM ID
                const domId = `msg-${msg.id || msg.temp_id || Date.now()}`;
                row.id = domId;

                // å¤´åƒæ¸²æŸ“
                const avatarSrc = isSelf ?
                    (myInfo.avatar ? SERVER_URL + myInfo.avatar : `https://ui-avatars.com/api/?name=${myInfo.username}`) :
                    `${SERVER_URL}/api/avatar/${msg.uid}`;

                let avatarHtml = '';
                if (isSelf) {
                    avatarHtml = `<img src="${avatarSrc}" class="chat-avatar">`;
                } else {
                    const safeSender = msg.sender.replace(/'/g, "\\'");
                    const safeAvatar = avatarSrc.replace(/'/g, "\\'");
                    avatarHtml = `<img src="${avatarSrc}" class="chat-avatar" onclick="showUserCard('${msg.uid}', '${safeSender}', '${safeAvatar}')">`;
                }

                // å¼•ç”¨å—æ¸²æŸ“ (æ”¯æŒå›¾ç‰‡æ˜¾ç¤ºä¸º [Image])
                let quoteHtml = '';
                if (msg.quote) {
                    let qContent = msg.quote.content;
                    // æ ¹æ®å¼•ç”¨ç±»å‹ä¼˜åŒ–æ˜¾ç¤ºæ–‡æœ¬
                    if (msg.quote.type === 'image') qContent = '[Image]';
                    else if (msg.quote.type === 'video') qContent = '[Video]';

                    quoteHtml = `
                        <div class="embedded-quote" onclick="jumpToMessage('${msg.quote.id}')">
                            <div class="quote-sender"><i class="fas fa-quote-left"></i> ${msg.quote.sender}</div>
                            <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${qContent}</div>
                        </div>
                    `;
                }

                // å†…å®¹ä¸èœå•é€»è¾‘
                let contentHtml = '';
                const fullMediaUrl = (msg.content && msg.content.startsWith('/uploads')) ? SERVER_URL + msg.content : msg.content;
                const safeContent = msg.content ? msg.content.replace(/'/g, "\\'") : "";

                // åªè¦ä¸æ˜¯è‡ªå·±å‘çš„æ¶ˆæ¯ï¼Œä»»ä½•æˆ¿é—´éƒ½å…è®¸æ˜¾ç¤ºèœå•ï¼ˆæ”¯æŒç§èŠäº’åŠ¨ï¼‰
                const showMenu = !isSelf;
                const menuAction = showMenu ? `onclick="toggleReactionMenu('${domId}', '${msg.id}', '${msg.sender}', '${safeContent}')"` : "";
                const cursorStyle = showMenu ? 'cursor:pointer' : '';

                if (msg.type === 'image') {
                    // å›¾ç‰‡äº¤äº’é€»è¾‘
                    if (isSelf) {
                        // è‡ªå·±å‘çš„å›¾ç‰‡ï¼šä¿æŒç‚¹å‡»æŸ¥çœ‹å¤§å›¾
                        contentHtml = `<img src="${fullMediaUrl}" class="chat-media" onclick="window.open(this.src)" loading="lazy">`;
                    } else {
                        // åˆ«äººå‘çš„å›¾ç‰‡ï¼šç‚¹å‡»å¼¹å‡ºäº’åŠ¨èœå• (ä¸å†æ”¾å¤§)
                        contentHtml = `<img src="${fullMediaUrl}" class="chat-media" style="${cursorStyle}" ${menuAction} loading="lazy">`;
                    }
                } else if (msg.type === 'video') {
                    contentHtml = `<video src="${fullMediaUrl}" class="chat-media" controls preload="metadata"></video>`;
                } else {
                    contentHtml = `<div class="msg-bubble" style="${cursorStyle}" ${menuAction}>${msg.content}</div>`;
                }

                // äº’åŠ¨èœå• HTML
                let menuHtml = '';
                if (showMenu) {
                    // æ³¨æ„ï¼šstartQuote å¢åŠ äº†ç¬¬4ä¸ªå‚æ•° msg.typeï¼Œç”¨äºæ­£ç¡®ä¿å­˜å¼•ç”¨ç±»å‹
                    menuHtml = `
                        <div id="menu-${domId}" class="reaction-menu">
                            <button class="menu-btn quote-btn" title="Reply" onclick="event.stopPropagation(); startQuote('${msg.id}', '${msg.sender}', '${safeContent}', '${msg.type}')"><i class="fas fa-reply"></i></button>
                            <button class="menu-btn" onclick="event.stopPropagation(); sendReaction('${msg.id}', 'like')">ğŸ‘</button>
                            <button class="menu-btn" onclick="event.stopPropagation(); sendReaction('${msg.id}', 'love')">â¤ï¸</button>
                            <button class="menu-btn" onclick="event.stopPropagation(); sendReaction('${msg.id}', 'question')">â“</button>
                            <button class="menu-btn" onclick="event.stopPropagation(); sendReaction('${msg.id}', 'dislike')">ğŸ‘</button>
                        </div>
                    `;
                }

                // äº’åŠ¨ç»Ÿè®¡æ¡
                let reactionBarHtml = `<div id="reaction-bar-${msg.id}" class="reaction-bar"></div>`;
                const cachedReactions = reactionDataCache[msg.id] || {};
                if (Object.keys(cachedReactions).length > 0) {
                    reactionBarHtml = `<div id="reaction-bar-${msg.id}" class="reaction-bar">${buildReactionHtml(cachedReactions)}</div>`;
                }

                // --- J. ç»„è£… ---
                row.innerHTML = `
                    ${avatarHtml}
                    <div class="msg-content-group">
                        <div class="msg-timestamp">${msg.timestamp || ''}</div>
                        <div class="msg-bubble-container">
                            ${quoteHtml}
                            ${contentHtml}
                            ${menuHtml}
                        </div>
                        ${reactionBarHtml}
                    </div>
                `;
                list.appendChild(row);
            });

            // æ¢å¤ä¸Šä¼ è¿›åº¦æ¡
            if (clearMode) tempUploads.forEach(el => list.appendChild(el));

            // æ»šåŠ¨åˆ°åº•éƒ¨
            if (hasNewContent || clearMode) list.scrollTop = list.scrollHeight;
        }

        // æ„å»ºäº’åŠ¨å›¾æ ‡ HTML
        function buildReactionHtml(reactions) {
            const icons = { 'like': 'ğŸ‘', 'love': 'â¤ï¸', 'question': 'â“', 'dislike': 'ğŸ‘' };
            let html = '';
            for (let [type, count] of Object.entries(reactions)) {
                if (count > 0 && icons[type]) {
                    html += `<div class="reaction-pill">${icons[type]} ${count}</div>`;
                }
            }
            return html;
        }

        // --- äº¤äº’ï¼šç‚¹å‡»æ°”æ³¡æ˜¾ç¤º/éšè—èœå• ---
        function toggleReactionMenu(domId, msgId, sender, content) {
            // å…ˆå…³é—­æ‰€æœ‰å…¶ä»–èœå•
            document.querySelectorAll('.reaction-menu').forEach(el => {
                if (el.id !== `menu-${domId}`) el.classList.remove('show');
            });

            const menu = document.getElementById(`menu-${domId}`);
            if(menu) {
                menu.classList.toggle('show');
                // ç‚¹å‡»å¤–éƒ¨è‡ªåŠ¨å…³é—­
                if(menu.classList.contains('show')) {
                    setTimeout(() => {
                        const closer = (e) => {
                            if(!e.target.closest(`#${domId}`)) {
                                menu.classList.remove('show');
                                window.removeEventListener('click', closer);
                            }
                        };
                        window.addEventListener('click', closer);
                    }, 0);
                }
            }
        }

        // --- äº¤äº’ï¼šå‘é€äº’åŠ¨ ---
        function sendReaction(msgId, type) {
            if(!msgId) return;

            // ç«‹å³æ›´æ–°æœ¬åœ°ç¼“å­˜ (ä¹è§‚æ›´æ–°)
            if (!reactionDataCache[msgId]) {
                reactionDataCache[msgId] = {};
            }
            const currentCount = reactionDataCache[msgId][type] || 0;
            reactionDataCache[msgId][type] = currentCount + 1;

            // ç«‹å³æ›´æ–° UI
            updateMessageReactions(msgId, reactionDataCache[msgId]);

            // å‘é€ç½‘ç»œè¯·æ±‚
            fetch('/api/send_reaction', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    msg_id: msgId,
                    reaction_type: type,
                    target_uid: currentTarget // <--- æ–°å¢ï¼šå‘Šè¯‰æœåŠ¡å™¨è¿™æ˜¯å“ªä¸ªæˆ¿é—´çš„äº’åŠ¨
                })
            }).catch(err => {
                console.error("Reaction failed:", err);
            });

            // å…³é—­èœå•
            document.querySelectorAll('.reaction-menu').forEach(el => el.classList.remove('show'));
        }

        // --- äº¤äº’ï¼šSocket æ›´æ–°äº’åŠ¨ ---
        function updateMessageReactions(msgId, reactions) {
            const bar = document.getElementById(`reaction-bar-${msgId}`);
            if(bar) bar.innerHTML = buildReactionHtml(reactions);
        }

        // --- äº¤äº’ï¼šå¼€å§‹å¼•ç”¨ ---
        function startQuote(msgId, sender, content, type = 'text') {
            // ä¿å­˜å¼•ç”¨æ—¶è®°å½•ç±»å‹
            currentQuote = { id: msgId, sender: sender, content: content, type: type };

            const bar = document.getElementById('quote-preview-bar');
            if (bar) {
                bar.style.display = 'flex';
                document.getElementById('quote-preview-sender').innerText = sender;

                // æ ¹æ®ç±»å‹æ˜¾ç¤ºé¢„è§ˆæ–‡å­—
                let displayText = content;
                if (type === 'image') displayText = '[Image]';
                else if (type === 'video') displayText = '[Video]';

                document.getElementById('quote-preview-text').innerText = displayText;

                document.getElementById('msg-text').focus();
            }
            document.querySelectorAll('.reaction-menu').forEach(el => el.classList.remove('show'));
        }

        // --- äº¤äº’ï¼šå–æ¶ˆå¼•ç”¨ ---
        function cancelQuote() {
            currentQuote = null;
            document.getElementById('quote-preview-bar').style.display = 'none';
        }

        // --- äº¤äº’ï¼šè·³è½¬åˆ°å¼•ç”¨æ¶ˆæ¯ ---
        function jumpToMessage(msgId) {
            const target = document.getElementById(`msg-${msgId}`);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // é«˜äº®é—ªçƒ
                target.style.transition = 'background 0.5s';
                target.style.backgroundColor = '#fff3cd'; // æµ…é»„è‰²é«˜äº®
                setTimeout(() => target.style.backgroundColor = 'transparent', 1500);
            } else {
                showNotification("Message not in current view (too old).");
            }
        }

        function switchChat(uid, name) {
            currentTarget = uid;

            // æ›´æ–°æœ€åé˜…è¯»æ—¶é—´
            lastReadMap[uid] = Date.now();

            // æ›´æ–°æ ‡é¢˜
            document.getElementById('current-chat-title').innerText = name || (uid === 'global' ? 'Global Chat Room' : 'Chat');

            // æ¸…ç©ºè§†å›¾ & æŒ‡çº¹
            document.getElementById('msg-list').innerHTML = '';
            renderedFingerprints.clear();

            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            const list = document.getElementById('msg-list');
            list.innerHTML = `
                <div style="display:flex; justify-content:center; align-items:center; height:100%; color:#888;">
                    <div style="text-align:center;">
                        <i class="fas fa-circle-notch fa-spin" style="font-size: 2rem; margin-bottom: 10px; color: var(--primary-color);"></i>
                        <div>Loading history...</div>
                    </div>
                </div>
            `;

            // è·å–é™åˆ¶
            const limit = parseInt(localStorage.getItem('chat_history_limit')) || 128;

            // ä¸å†ç›´æ¥ emitï¼Œè€Œæ˜¯è¯·æ±‚ Python ä»£ç†
            fetch('/api/request_history', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    target_uid: uid,
                    limit: limit
                })
            })
            .then(r => r.json())
            .then(resp => {
                if (resp.status === 'ok') {
                    // æ‹¿åˆ°æ•°æ®ï¼Œæ¸²æŸ“ç•Œé¢
                    // ä½¿ç”¨ true (clearMode) æ¸…é™¤ Loading æç¤ºå¹¶æ¸²æŸ“
                    if (resp.messages.length === 0) {
                         list.innerHTML = `<div style="text-align:center; padding-top:50px; color:#ccc;">No history found.</div>`;
                    } else {
                         renderMessages(resp.messages, true);
                    }
                } else {
                    console.error("Failed to load history:", resp.msg);
                    list.innerHTML = `<div style="text-align:center; padding-top:50px; color:#e74c3c;">Error: ${resp.msg}</div>`;
                }
            })
            .catch(err => {
                console.error("API Error:", err);
                list.innerHTML = `<div style="text-align:center; padding-top:50px; color:#e74c3c;">Network Error</div>`;
            });
        }

        function sendMsg() {
            const input = document.getElementById('msg-text');
            const text = input.value.trim();
            if(!text) return;

            // æ„é€  Payloadï¼Œå¦‚æœæœ‰ currentQuote åˆ™å¸¦ä¸Š
            const payload = {
                content: text,
                type: 'text',
                target_uid: currentTarget,
                quote: currentQuote
            };

            fetch('/api/send_message', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            input.value = '';
            lastReadMap[currentTarget] = Date.now();

            // å‘é€å®Œæ¯•ï¼Œæ¸…é™¤å¼•ç”¨çŠ¶æ€
            if(currentQuote) cancelQuote();
        }
        // æ–°å¢ï¼šå‹ç¼©å›¾ç‰‡çš„è¾…åŠ©å‡½æ•°
        async function compressImage(file, targetSizeKB) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // ä¿æŒåŸå§‹å®½é«˜æ¯”
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        // è¿­ä»£è°ƒæ•´è´¨é‡ï¼Œå°è¯•æ¥è¿‘ç›®æ ‡å¤§å° (140KB)
                        let quality = 0.7;
                        let dataUrl = canvas.toDataURL('image/jpeg', quality);

                        // å¦‚æœå‹ç¼©åè¿˜æ˜¯å¤ªå¤§ï¼Œç»§ç»­é™ä½è´¨é‡
                        while (dataUrl.length / 1024 > targetSizeKB && quality > 0.1) {
                            quality -= 0.1;
                            dataUrl = canvas.toDataURL('image/jpeg', quality);
                        }

                        // å°† DataURL è½¬å› Blob
                        const byteString = atob(dataUrl.split(',')[1]);
                        const ab = new ArrayBuffer(byteString.length);
                        const ia = new Uint8Array(ab);
                        for (let i = 0; i < byteString.length; i++) {
                            ia[i] = byteString.charCodeAt(i);
                        }
                        resolve(new Blob([ab], { type: 'image/jpeg' }));
                    };
                };
            });
        }

        async function handleMediaUpload(input) {
            if (!input.files[0]) return;
            let file = input.files[0];
            const originalSizeKB = file.size / 1024;

            // --- 1. Automatic Compression (For images exceeding 196KB) ---
            if (originalSizeKB > 196 && file.type.startsWith('image/')) {
                showNotification("File size exceeds 196KB. Compressing...");
                file = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);

                            let quality = 0.8;
                            let resultBlob = file;

                            const checkAndCompress = (q) => {
                                const dataUrl = canvas.toDataURL('image/jpeg', q);
                                const byteString = atob(dataUrl.split(',')[1]);
                                const ab = new ArrayBuffer(byteString.length);
                                const ia = new Uint8Array(ab);
                                for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
                                return new Blob([ab], { type: 'image/jpeg' });
                            };

                            resultBlob = checkAndCompress(quality);
                            // Iterate quality down to reach target around 140KB
                            while (resultBlob.size / 1024 > 140 && quality > 0.1) {
                                quality -= 0.1;
                                resultBlob = checkAndCompress(quality);
                            }
                            resolve(resultBlob);
                        };
                    };
                });
            }

            // --- 2. Final Size Validation (Must not exceed 300KB) ---
            const finalSizeKB = file.size / 1024;
            if (finalSizeKB > 300) {
                showNotification(`File too large (${Math.round(finalSizeKB)}KB). Max limit is 300KB.`);
                input.value = '';
                return;
            }

            // --- 3. Upload Logic ---
            const tempId = "t_" + Date.now();
            const list = document.getElementById('msg-list');
            const row = document.createElement('div');
            row.className = "message-row self";
            row.id = tempId;
            row.innerHTML = `
                <div class="msg-content-group">
                    <div class="upload-progress-container">
                        <div style="font-size:11px; font-weight:bold;">Uploading...</div>
                        <progress id="p-${tempId}" value="0" max="100"></progress>
                    </div>
                </div>`;
            list.appendChild(row);
            list.scrollTop = list.scrollHeight;

            const fd = new FormData();
            const fileName = file.type === 'image/jpeg' ? "compressed_image.jpg" : file.name;
            fd.append('file', file, fileName);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', SERVER_URL + '/api/upload_media', true);

            xhr.upload.onprogress = (e) => {
                if(e.lengthComputable) {
                    const prog = document.getElementById(`p-${tempId}`);
                    if(prog) prog.value = (e.loaded / e.total) * 100;
                }
            };

            xhr.onload = () => {
                if (xhr.status === 200) {
                    const r = JSON.parse(xhr.responseText);
                    fetch('/api/send_message', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            content: r.url,
                            type: file.type.startsWith('video') ? 'video' : 'image',
                            target_uid: currentTarget
                        })
                    });
                    row.remove();
                } else {
                    showNotification("Upload failed: Exceeds server limits.");
                    row.remove();
                }
            };

            xhr.onerror = () => {
                showNotification("Network error. Upload interrupted.");
                row.remove();
            };

            xhr.send(fd);
            input.value = '';
        }

        function fetchFriends() {
            fetch('/api/get_friends')
                .then(r => r.json())
                .then(data => {
                    // data åº”è¯¥æ˜¯ [{uid, username, avatar}, ...]
                    friendsList = data;

                    // å¦‚æœå¥½å‹èœå•å½“å‰æ˜¯æ‰“å¼€çŠ¶æ€ï¼Œç«‹å³åˆ·æ–°åˆ—è¡¨UI
                    const modal = document.getElementById('friends-modal');
                    if (modal && modal.style.display === 'flex') {
                        openFriendsModal();
                    }
                })
                .catch(e => console.error("Fetch friends error:", e));
        }

        function showUserCard(uid, username, avatarSrc) {
            if (uid === myInfo.uid) return;
            currentCardUser = { uid, username, avatar: avatarSrc };
            document.getElementById('uc-avatar').src = avatarSrc;
            document.getElementById('uc-username').innerText = username;
            document.getElementById('uc-uid').innerText = "UID: " + uid;
            document.getElementById('user-card-overlay').style.display = 'flex';
        }

        function closeUserCard() { document.getElementById('user-card-overlay').style.display = 'none'; }

        function startPrivateChatFromCard() {
            if(currentCardUser.uid) {
                switchChat(currentCardUser.uid, currentCardUser.username);
                closeUserCard();
            }
        }

        function addFriendAction() {
            // Send to Backend
            fetch('/api/add_friend', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(currentCardUser)
            }).then(r => r.json()).then(d => {
                if(d.status === 'ok') {
                    showNotification("Friend Added!");
                    fetchFriends(); // Reload list
                } else if (d.status === 'exists') {
                    showNotification("Already Friends");
                }
            });
            closeUserCard();
        }

        function openFriendsModal() {
            const container = document.getElementById('friends-list-container');
            container.innerHTML = '';

            // æ„å»ºæ˜¾ç¤ºåˆ—è¡¨ï¼šAdmin + å®é™…å¥½å‹
            // Admin é»˜è®¤ä½œä¸ºå¥½å‹æ˜¾ç¤ºï¼Œä½†ä¸å¯åˆ é™¤ï¼ˆæˆ–è€…å¯ä»¥åªæ˜¯éšè—ï¼‰
            const displayList = [
                {uid: 'ADMIN', username: 'System Admin', avatar: ''},
                ...friendsList
            ];

            if (displayList.length === 0) {
                container.innerHTML = '<p style="color:#999; text-align:center;">No friends found.</p>';
            } else {
                displayList.forEach(f => {
                    const div = document.createElement('div');
                    div.className = 'friend-item';

                    // ç‚¹å‡»è¡Œè¿›å…¥èŠå¤©
                    div.onclick = (e) => {
                        switchChat(f.uid, f.username);
                        closeFriendsModal();
                    };

                    const ava = f.uid === 'ADMIN'
                        ? "https://ui-avatars.com/api/?name=Admin&background=000&color=fff"
                        : `${SERVER_URL}/api/avatar/${f.uid}`;

                    // ç”Ÿæˆä¸‰ç‚¹èœå• (Admin ä¸æ˜¾ç¤ºåˆ é™¤é€‰é¡¹)
                    let menuHtml = '';
                    if (f.uid !== 'ADMIN') {
                        menuHtml = `
                            <div class="friend-actions" onclick="event.stopPropagation()">
                                <button class="friend-menu-btn" onclick="toggleFriendMenu(this, '${f.uid}')">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div id="f-menu-${f.uid}" class="friend-dropdown">
                                    <div class="friend-dropdown-item" onclick="deleteFriend('${f.uid}')">Delete</div>
                                </div>
                            </div>
                        `;
                    }

                    div.innerHTML = `
                        <img src="${ava}" class="friend-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${f.username}'">
                        <div style="flex:1;">
                            <div style="font-weight:bold;">${f.username}</div>
                            <div style="font-size:0.8rem; color:#888;">UID: ${f.uid}</div>
                        </div>
                        ${menuHtml}
                    `;
                    container.appendChild(div);
                });
            }
            document.getElementById('friends-modal').style.display = 'flex';
        }

        // --- æ–°å¢ï¼šåˆ‡æ¢å¥½å‹èœå•æ˜¾ç¤º ---
        function toggleFriendMenu(btn, uid) {
            // å…³é—­å…¶ä»–æ‰“å¼€çš„èœå•
            document.querySelectorAll('.friend-dropdown').forEach(el => el.classList.remove('show'));

            const menu = document.getElementById(`f-menu-${uid}`);
            if (menu) menu.classList.toggle('show');
        }

        // --- æ–°å¢ï¼šåˆ é™¤å¥½å‹é€»è¾‘ ---
        function deleteFriend(uid) {
            if(!confirm("Are you sure you want to delete this friend?")) return;

            fetch('/api/delete_friend', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ uid: uid })
            })
            .then(r => r.json())
            .then(data => {
                if(data.status === 'ok') {
                    // æ›´æ–°æœ¬åœ°åˆ—è¡¨
                    friendsList = friendsList.filter(f => f.uid !== uid);
                    openFriendsModal(); // åˆ·æ–°åˆ—è¡¨
                    showNotification("Friend deleted");
                } else {
                    showNotification("Error deleting friend");
                }
            });
        }

        // ç‚¹å‡»çª—å£ä»»æ„ä½ç½®å…³é—­å¥½å‹å°èœå•
        window.addEventListener('click', function(e) {
            if (!e.target.closest('.friend-actions')) {
                document.querySelectorAll('.friend-dropdown').forEach(el => el.classList.remove('show'));
            }
        });

        function closeFriendsModal() { document.getElementById('friends-modal').style.display = 'none'; }

        // --- Settings & Auth ---
        function openSettings() {
            const prev = document.getElementById('settings-avatar-preview');
            if(myInfo.avatar) prev.src = SERVER_URL + myInfo.avatar;
            else prev.src = `https://ui-avatars.com/api/?name=${myInfo.username}`;

            document.getElementById('st-username').value = '';
            document.getElementById('st-password').value = '';
            document.getElementById('st-code').value = '';

            // å›æ˜¾ limit
            const savedLimit = localStorage.getItem('chat_history_limit') || 128;
            document.getElementById('st-history-limit').value = savedLimit;

            // --- æ–°å¢ï¼šå›æ˜¾ "Hide Admin in Global" è®¾ç½® ---
            const hideGlobal = localStorage.getItem('hide_admin_global') === 'true';
            const hideCheckbox = document.getElementById('st-hide-admin-global');
            if (hideCheckbox) {
                hideCheckbox.checked = hideGlobal;
            }
            // ---------------------------------------------

            document.getElementById('st-error-msg').style.display='none';
            document.getElementById('settings-modal').style.display='flex';
        }
        function closeSettings() { document.getElementById('settings-modal').style.display='none'; }

        function checkPasswordInput() {
            const v = document.getElementById('st-password').value;
            document.getElementById('btn-settings-code').disabled = (v.length === 0);
        }

        function uploadAvatarImmediately(input) {
            if(input.files[0]) {
                const r = new FileReader();
                r.onload = e => {
                    const b64 = e.target.result;
                    document.getElementById('settings-avatar-preview').src = b64;
                    document.getElementById('my-avatar-img').src = b64;
                    fetch('/api/update_profile', {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({ new_avatar: b64 })
                    }).then(() => showNotification("Avatar Updated!"));
                };
                r.readAsDataURL(input.files[0]);
            }
        }

        function saveProfile() {
            const u = document.getElementById('st-username').value.trim();
            const p = document.getElementById('st-password').value.trim();
            const c = document.getElementById('st-code').value.trim();
            const l = document.getElementById('st-history-limit').value.trim();

            // ä¿å­˜ limit åˆ° localStorage
            if(l) localStorage.setItem('chat_history_limit', l);

            // --- æ–°å¢ï¼šä¿å­˜ "Hide Admin in Global" è®¾ç½® ---
            const hideCheckbox = document.getElementById('st-hide-admin-global');
            if (hideCheckbox) {
                localStorage.setItem('hide_admin_global', hideCheckbox.checked);
            }

            // å¦‚æœå½“å‰æ­£åœ¨ Global èŠå¤©å®¤ï¼Œç«‹å³åˆ·æ–°ä»¥åº”ç”¨å±è”½/å–æ¶ˆå±è”½
            if (currentTarget === 'global') {
                switchChat('global', 'Global Chat Room');
            }
            // ---------------------------------------------

            if(p && !c) { document.getElementById('st-error-msg').style.display='block'; return; }
            const data = {};
            if(u) data.new_username = u;
            if(p) { data.new_password = p; data.code = c; }

            if(Object.keys(data).length > 0) {
                fetch('/api/update_profile', {
                    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)
                }).then(() => {
                    showNotification("Settings Saved");
                    if(u) { myInfo.username = u; document.getElementById('my-name-display').innerText = u; }
                    closeSettings();
                });
            } else {
                showNotification("Settings Saved");
                closeSettings();
            }
        }

        function showNotification(msg) {
            const bar = document.getElementById('notification-bar');
            document.getElementById('notify-content').innerHTML = msg;
            bar.classList.add('show');
            setTimeout(() => bar.classList.remove('show'), 4000);
        }
        function requestCode() { fetch('/api/request_code', {method:'POST'}); }
        function doLogin() {
            const data = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                code: document.getElementById('code').value
            };
            fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        }
        function doLogout() {
            // å¼ºåˆ¶æ¸…é™¤æ‰€æœ‰æœ¬åœ°å˜é‡
            myInfo = { username: '', uid: '', avatar: '' };
            // previousMsgCount å˜é‡ä¼¼ä¹æœªåœ¨æä¾›çš„ç‰‡æ®µä¸­å®šä¹‰ï¼Œå¦‚æœåœ¨åˆ«å¤„å®šä¹‰äº†è¯·ä¿ç•™ï¼Œå¦åˆ™å¯åˆ é™¤
            if (typeof previousMsgCount !== 'undefined') previousMsgCount = 0;
            lastReadMap = {};

            fetch('/api/logout', {method:'POST'}).then(() => {
                // åˆ·æ–°é¡µé¢æ˜¯è§£å†³ Socket é‡å¤ç›‘å¬æœ€ç®€å•å½»åº•çš„æ–¹æ³•
                window.location.reload();
            });
        }

        function initRandomBackground() {
            const overlay = document.getElementById('auth-overlay');
            if(!overlay) return;

            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å…‰æ™• (é˜²æ­¢å¤šæ¬¡è°ƒç”¨å †ç§¯)
            const oldOrbs = overlay.querySelectorAll('.orb');
            oldOrbs.forEach(el => el.remove());

            // 1. è·å–å¯è§†çª—å£å¤§å°
            const winW = window.innerWidth;
            const winH = window.innerHeight;

            // 2. éšæœºä¸ªæ•°ï¼š3 åˆ° 6 ä¸ª
            const count = Math.floor(Math.random() * (6 - 3 + 1)) + 3;

            // é¢œè‰²æ± 
            const colors = ['#0084ff', '#9b59b6', '#1abc9c', '#3498db', '#e67e22', '#2ecc71', '#e74c3c'];

            // ç”¨äºå­˜å‚¨å·²æ”¾ç½®åœ†çš„ä¿¡æ¯ï¼Œç”¨äºç¢°æ’æ£€æµ‹
            // ç»“æ„: { x, y, radius } (x,y æ˜¯åœ†å¿ƒåæ ‡)
            const placedOrbs = [];

            for (let i = 0; i < count; i++) {
                let orbData = null;
                let attempts = 0;
                const maxAttempts = 100; // æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œé˜²æ­¢æ­»å¾ªç¯

                // --- å°è¯•æ”¾ç½®ç®—æ³• (Rejection Sampling) ---
                while (attempts < maxAttempts) {
                    // éšæœºå¤§å°: 200px åˆ° 500px (å¦‚æœå±å¹•å°ï¼Œè‡ªåŠ¨ç¼©å°ä¸Šé™)
                    const maxSize = Math.min(500, Math.min(winW, winH) * 0.6);
                    const size = Math.floor(Math.random() * (maxSize - 200 + 1)) + 200;
                    const radius = size / 2;

                    // éšæœºä½ç½® (ç¡®ä¿å®Œå…¨åœ¨å±å¹•å†…)
                    // x èŒƒå›´: 0 åˆ° (å±å¹•å®½ - åœ†å®½)
                    const left = Math.floor(Math.random() * (winW - size));
                    const top = Math.floor(Math.random() * (winH - size));

                    // è®¡ç®—åœ†å¿ƒ
                    const centerX = left + radius;
                    const centerY = top + radius;

                    // æ£€æŸ¥ç¢°æ’
                    let overlap = false;
                    for (const existing of placedOrbs) {
                        const dx = centerX - existing.x;
                        const dy = centerY - existing.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        // å¦‚æœåœ†å¿ƒè·ç¦» < ä¸¤åœ†åŠå¾„ä¹‹å’Œï¼Œåˆ™é‡å 
                        if (distance < (radius + existing.radius)) {
                            overlap = true;
                            break;
                        }
                    }

                    if (!overlap) {
                        // æ‰¾åˆ°æœ‰æ•ˆä½ç½®ï¼Œä¿å­˜æ•°æ®å¹¶é€€å‡ºå°è¯•å¾ªç¯
                        orbData = { left, top, size, radius, x: centerX, y: centerY };
                        placedOrbs.push(orbData);
                        break;
                    }
                    attempts++;
                }

                // å¦‚æœå°è¯•å¾ˆå¤šæ¬¡è¿˜æ˜¯æ²¡åœ°æ–¹æ”¾ï¼Œå°±è·³è¿‡è¿™ä¸ªçƒï¼ˆé¿å…å¡æ­»ï¼‰
                if (!orbData) continue;

                // --- åˆ›å»º DOM å…ƒç´  ---
                const orb = document.createElement('div');
                orb.classList.add('orb');

                orb.style.width = orbData.size + 'px';
                orb.style.height = orbData.size + 'px';
                orb.style.left = orbData.left + 'px';
                orb.style.top = orbData.top + 'px';

                const color = colors[Math.floor(Math.random() * colors.length)];
                orb.style.background = color;

                const duration = Math.floor(Math.random() * (35 - 18 + 1)) + 18; // 18s-35s
                const delay = Math.floor(Math.random() * 10) * -1;

                orb.style.animationDuration = duration + 's';
                orb.style.animationDelay = delay + 's';

                overlay.prepend(orb);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.addEventListener('load', initRandomBackground);
        // çª—å£å¤§å°å‰§çƒˆæ”¹å˜æ—¶ï¼ˆå¦‚æ—‹è½¬å±å¹•ï¼‰ï¼Œé‡æ–°ç”Ÿæˆä»¥é€‚åº”æ–°è¾¹ç•Œ
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(initRandomBackground, 300);
        });


        // ç”¨æˆ·åè¾“å…¥ç›‘å¬ä¸å¤´åƒè‡ªåŠ¨è·å–
        let userCheckTimer;
        const usernameInput = document.getElementById('username');
        const halo = document.getElementById('login-halo');

        // å…¨å±€å˜é‡è¿½è¸ªè¿æ¥çŠ¶æ€ (éœ€è¦åœ¨ status è½®è¯¢ä¸­æ›´æ–°)
        let isServerConnected = false;

        // ç›‘å¬è¾“å…¥
        usernameInput.addEventListener('input', function(e) {
            const val = e.target.value.trim();

            // 1. å¦‚æœæ²¡æœ‰è¿æ¥ Serverï¼Œæˆ–è€…æ˜¯ç©ºæ–‡æœ¬ï¼Œæ¢å¤é»˜è®¤
            if (!isServerConnected || val.length === 0) {
                resetHalo();
                return;
            }

            // 2. é˜²æŠ–ï¼šåœæ­¢è¾“å…¥ 500ms åå†å‘é€è¯·æ±‚
            clearTimeout(userCheckTimer);
            userCheckTimer = setTimeout(() => {
                fetch('/api/check_user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: val})
                })
                .then(r => r.json())
                .then(data => {
                    if (data.exists) {
                        // ç”¨æˆ·å­˜åœ¨ï¼šæ˜¾ç¤ºå¤´åƒ
                        // å¦‚æœæœ‰è‡ªå®šä¹‰å¤´åƒç”¨è‡ªå®šä¹‰ï¼Œæ²¡æœ‰åˆ™ç”¨ UI Avatars ç”Ÿæˆ
                        let avatarUrl = '';
                        if (data.avatar) {
                            avatarUrl = SERVER_URL + data.avatar;
                        } else {
                            avatarUrl = `https://ui-avatars.com/api/?name=${val}&background=random`;
                        }
                        halo.innerHTML = `<img src="${avatarUrl}" onerror="this.src='https://ui-avatars.com/api/?name=${val}'">`;
                    } else {
                        // ç”¨æˆ·ä¸å­˜åœ¨ï¼šæ¢å¤é»˜è®¤
                        resetHalo();
                    }
                })
                .catch(err => console.error("User check failed:", err));
            }, 500);
        });

        function resetHalo() {
            // æ¢å¤å›¾æ ‡çŠ¶æ€
            // é¿å…é‡å¤é‡ç½®å¯¼è‡´é—ªçƒ
            if (!halo.querySelector('i')) {
                halo.innerHTML = '<i class="fas fa-comments"></i>';
            }
        }

    </script>
</body>
</html>