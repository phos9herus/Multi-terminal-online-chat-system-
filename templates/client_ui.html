<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Client</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #0084ff;
            --bg-gray: #f0f2f5;
            --sidebar-bg: #ffffff;
            --text-main: #1c1e21;
            --text-muted: #65676b;
            --msg-bubble-self: #0084ff;
            --msg-bubble-other: #e4e6eb;
            --error-red: #e74c3c;
            --unread-red: #ff3b30;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-gray); margin: 0; overflow: hidden; color: var(--text-main); }

        .app-container { display: none; width: 100vw; height: 100vh; background: white; overflow: hidden; }

        /* Sidebar Layout */
        .sidebar { width: 320px; background: var(--sidebar-bg); border-right: 1px solid #ddd; display: flex; flex-direction: column; z-index: 10; height: 100vh; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; height: 60px; box-sizing: border-box; }
        .sidebar-header h2 { font-size: 1.5rem; margin: 0; color: var(--primary-color); }

        .user-profile-bar { padding: 15px; background: #f9f9f9; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .my-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #ddd; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .my-info { flex: 1; overflow: hidden; }
        .my-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .my-uid { font-size: 0.75rem; color: #888; }

        /* Chat Tabs List */
        .chat-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }

        /* Sidebar Tab Item Style */
        .tab-item { padding: 12px 16px; display: flex; align-items: center; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; position: relative; height: 72px; box-sizing: border-box; }
        .tab-item:hover { background: #f5f6f7; }
        .tab-item.active { background: #e7f3ff; border-left-color: var(--primary-color); }

        .tab-avatar-container { position: relative; margin-right: 12px; }
        .tab-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }

        /* Unread Dot */
        .unread-dot {
            position: absolute; top: -2px; right: -2px; width: 12px; height: 12px;
            background: var(--unread-red); border-radius: 50%; border: 2px solid white;
            display: none; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .tab-item.unread .unread-dot { display: block; }

        .tab-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .tab-top { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; }
        .tab-name { font-weight: 600; font-size: 0.95rem; color: #050505; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
        .tab-time { font-size: 0.75rem; color: #bcc0c4; white-space: nowrap; margin-left: 5px; }

        .tab-preview {
            font-size: 0.85rem; color: var(--text-muted);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .tab-item.unread .tab-preview { font-weight: 600; color: #050505; }

        /* Friends Menu Button */
        .friends-menu-btn {
            padding: 15px; border-top: 1px solid #eee; background: #fff; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-weight: 600; color: #555; transition: background 0.2s;
        }
        .friends-menu-btn:hover { background: #f0f2f5; color: var(--primary-color); }

        /* Chat Area */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: white; height: 100vh; }
        .chat-header { height: 60px; padding: 0 25px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .chat-header .title { font-weight: bold; font-size: 1.1rem; }
        .status-indicator { color:#2ecc71; font-size:0.8rem; display:flex; align-items:center; gap:5px; }

        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #ffffff; }

        /* Messages */
        .message-row { display: flex; align-items: flex-start; width: 100%; animation: slideIn 0.2s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-row.self { flex-direction: row-reverse; }
        .chat-avatar { width: 36px; height: 36px; border-radius: 50%; margin: 0 8px; object-fit: cover; flex-shrink: 0; border: 1px solid #eee; cursor: pointer; }
        .chat-avatar:hover { transform: scale(1.05); }

        .msg-content-group { display: flex; flex-direction: column; max-width: 65%; }
        .message-row.self .msg-content-group { align-items: flex-end; }
        .msg-timestamp { font-size: 0.7rem; color: #bcc0c4; margin-bottom: 4px; padding: 0 4px; }

        .msg-bubble { padding: 10px 16px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .message-row.other .msg-bubble { background: var(--msg-bubble-other); color: black; border-top-left-radius: 4px; }
        .message-row.self .msg-bubble { background: var(--msg-bubble-self); color: white; border-top-right-radius: 4px; }
        .chat-media { border-radius: 12px; max-width: 100%; max-height: 350px; cursor: pointer; border: 1px solid #eee; display: block; }

        /* Input Area */
        .input-area { padding: 15px 20px; border-top: 1px solid #eee; display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .msg-input { flex: 1; background: #f0f2f5; border: none; padding: 12px 20px; border-radius: 20px; outline: none; font-size: 15px; }
        .icon-btn { background: none; border: none; color: var(--primary-color); font-size: 1.4rem; cursor: pointer; }

        .upload-progress-container { width: 200px; padding: 10px; background: #fff; border: 1px solid var(--primary-color); border-radius: 8px; margin-top: 5px; }
        progress { width: 100%; height: 6px; border-radius: 3px; }

        /* Modals & Overlays */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(2px); align-items: center; justify-content: center; }
        .modal-box { background: white; border-radius: 12px; padding: 30px; width: 350px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: popIn 0.2s ease; max-height: 80vh; overflow-y: auto; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Auth Styles */
        #auth-overlay { position: fixed; inset: 0; background: var(--bg-gray); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-full { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-danger { background: #fff; color: var(--error-red); border: 1px solid var(--error-red); margin-top: 20px; }
        .btn-danger:hover { background: #fff5f5; }

        /* User Card */
        .uc-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .uc-avatar { width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 3px solid #f0f2f5; }
        .uc-info { display: flex; flex-direction: column; }
        .uc-username { font-weight: bold; font-size: 1.1rem; }
        .uc-uid { font-size: 0.85rem; color: #888; background: #f0f2f5; padding: 2px 6px; border-radius: 4px; display: inline-block; align-self: flex-start; }
        .uc-actions { display: flex; gap: 10px; }
        .uc-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 5px; }

        /* Friend Item */
        .friend-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; }
        .friend-item:hover { background: #f9f9f9; }
        .friend-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; border: 1px solid #eee; object-fit: cover;}

        /* Settings specific */
        .avatar-upload-container { display: flex; justify-content: center; margin-bottom: 25px; }
        .avatar-preview-wrapper { width: 90px; height: 90px; border-radius: 50%; margin: 0 auto 20px; overflow: hidden; cursor: pointer; border: 3px solid #f0f2f5; position: relative; }
        .avatar-preview-img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; color: white; opacity: 0; transition: 0.2s; font-size: 1.5rem; }
        .avatar-preview-wrapper:hover .avatar-overlay { opacity: 1; }

        #notification-bar { position: fixed; top: -80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 25px; border-radius: 50px; transition: top 0.4s; z-index: 3000; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        #notification-bar.show { top: 25px; }

        .friend-actions { position: relative; margin-left: auto; }
        .friend-menu-btn {
            background: none; border: none; cursor: pointer; color: #999;
            padding: 5px 10px; font-size: 1.1rem;
        }
        .friend-menu-btn:hover { color: var(--primary-color); }

        .friend-dropdown {
            display: none; position: absolute; right: 0; top: 100%;
            background: white; border: 1px solid #ddd; border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 100; min-width: 80px;
        }
        .friend-dropdown.show { display: block; }
        .friend-dropdown-item {
            padding: 8px 12px; font-size: 0.85rem; color: #333; cursor: pointer;
            white-space: nowrap;
        }
        .friend-dropdown-item:hover { background: #f5f5f5; color: var(--error-red); }

        /* 设置界面通用设置样式 */
        .settings-section { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .switch-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-size: 0.9rem; color: #333; }
        .toggle-checkbox { transform: scale(1.2); }
    </style>
</head>
<body>
    <div id="notification-bar"><span id="notify-content"></span></div>

    <div id="auth-overlay">
        <div class="modal-box" style="text-align:center;">
            <h2 style="margin-bottom:10px; color:#333;">Chat Connect</h2>
            <div id="login-status-indicator" style="margin-bottom: 20px; font-size: 0.85rem; font-weight: bold; color: #f39c12;">
                <i class="fas fa-circle-notch fa-spin"></i> Connecting to Server...
            </div>
            <p style="color:#666; font-size:0.9rem; margin-bottom:25px;">Secure Terminal Login</p>
            <input type="text" id="username" class="auth-input" placeholder="Username / UID">
            <input type="password" id="password" class="auth-input" placeholder="Password">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="code" class="auth-input" placeholder="Code" style="margin-bottom:0; text-align:center;">
                <button onclick="requestCode()" style="padding:0 15px; background:#e7f3ff; color:var(--primary-color); border:1px solid var(--primary-color); border-radius:8px; cursor:pointer; font-weight:600;">Get Code</button>
            </div>
            <button class="btn-full" onclick="doLogin()">Enter Chat</button>
        </div>
    </div>

    <div class="app-container" id="app">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Chats</h2>
                <i class="fas fa-cog" style="cursor:pointer; color:#888; font-size:1.1rem;" onclick="openSettings()"></i>
            </div>
            <div class="user-profile-bar">
                <img id="my-avatar-img" class="my-avatar" src="" onerror="this.src='https://ui-avatars.com/api/?name=Me'" onclick="openSettings()">
                <div class="my-info">
                    <div id="my-name-display" class="my-name">Guest</div>
                    <div id="my-uid-display" class="my-uid">UID: ---</div>
                </div>
            </div>

            <div class="chat-list" id="chat-tabs-container">
                </div>

            <div class="friends-menu-btn" onclick="openFriendsModal()">
                <i class="fas fa-user-friends"></i> Friends Menu
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <div class="title" id="current-chat-title">Global Chat Room</div>
                <div class="status-indicator"><i class="fas fa-circle" style="font-size:0.6rem;"></i> Online</div>
            </div>
            <div class="messages" id="msg-list"></div>
            <div class="input-area">
                <button class="icon-btn" onclick="document.getElementById('media-upload').click()"><i class="fas fa-plus-circle"></i></button>
                <input type="file" id="media-upload" hidden accept="image/*,video/*" onchange="handleMediaUpload(this)">
                <input type="text" class="msg-input" id="msg-text" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMsg()">
                <button class="icon-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="user-card-overlay" onclick="closeUserCard()" style="display:none;">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="uc-header">
                <img id="uc-avatar" class="uc-avatar" src="">
                <div class="uc-info">
                    <div id="uc-username" class="uc-username">Username</div>
                    <div id="uc-uid" class="uc-uid">UID: ---</div>
                </div>
            </div>
            <div class="uc-actions">
                <button class="uc-btn" style="background:#e4e6eb; color:#000;" onclick="addFriendAction()"><i class="fas fa-user-plus"></i> Add Friend</button>
                <button class="uc-btn" style="background:var(--primary-color); color:#fff;" onclick="startPrivateChatFromCard()"><i class="fas fa-comment-dots"></i> Message</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="friends-modal" onclick="closeFriendsModal()" style="display:none;">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 style="margin-top:0;">My Friends</h3>
            <div id="friends-list-container" style="max-height: 300px; overflow-y:auto;">
                <p style="color:#999; text-align:center;">Loading...</p>
            </div>
            <button class="btn-full" style="margin-top:15px; background:#eee; color:#333;" onclick="closeFriendsModal()">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal" onclick="closeSettings()" style="display:none;">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 style="margin-top:0; text-align:center;">Settings</h3>

            <div class="avatar-upload-container">
                <div class="avatar-preview-wrapper" onclick="document.getElementById('st-avatar-input').click()">
                    <img id="settings-avatar-preview" class="avatar-preview-img" src="">
                    <div class="avatar-overlay"><i class="fas fa-camera"></i></div>
                </div>
                <input type="file" id="st-avatar-input" accept="image/*" hidden onchange="uploadAvatarImmediately(this)">
            </div>

            <input type="text" id="st-username" class="auth-input" placeholder="New Username">

            <input type="password" id="st-password" class="auth-input" placeholder="New Password" oninput="checkPasswordInput()">

            <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 5px; margin-top: 10px;">Chat History Limit (Default: 128)</label>
            <input type="number" id="st-history-limit" class="auth-input" placeholder="128" value="128">

            <div style="border-top: 1px solid #eee; margin: 15px 0; padding-top: 15px;">
                <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 5px;">Verification Code (For Password Change)</label>

                <input type="text" id="st-code" class="auth-input" placeholder="Enter Code">

                <button id="btn-settings-code" onclick="requestCode()" class="btn-full"
                    style="margin-bottom: 10px; background:#e7f3ff; color:var(--primary-color); border: 1px solid var(--primary-color);" disabled>
                    Get Verification Code
                </button>
            </div>

            <div id="st-error-msg" style="color:red; font-size:12px; margin-bottom:10px; display:none;">Need code to change password</div>

            <button class="btn-full" onclick="saveProfile()" style="background:#2ecc71;">Save Changes</button>

            <button class="btn-full btn-danger" onclick="doLogout()">Logout</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const SERVER_URL = "{{ server_url }}";
        const socket = io(SERVER_URL);

        let myInfo = { username: '', uid: '', avatar: '' };
        let currentTarget = 'global';


        // Unread tracking
        let lastReadMap = {};

        const renderedFingerprints = new Set();

        // Friends Data
        let friendsList = [];

        // Temp storage for user card
        let currentCardUser = {};

        socket.on('connect', () => console.log("[Socket] Connected"));

        socket.on('history_loaded', (data) => {
            // data 结构: { messages: [], target_uid: '...' }

            // 只有当返回的数据属于当前正在查看的聊天对象时，才渲染
            // 注意：data.target_uid 可能是 'global' 或 具体的 UID
            // currentTarget 也是 'global' 或 具体的 UID

            if (data.target_uid === currentTarget || (data.target_uid === 'global' && currentTarget === 'global')) {
                // 使用 true 开启清除模式 (Clear Mode)，因为这是加载历史记录，需要替换当前屏幕内容
                renderMessages(data.messages, false);
            }
        });

        // Helper: Parse server timestamp "YYYY-MM-DD HH:MM:SS" to milliseconds
        function parseTimestamp(tsStr) {
            if (!tsStr) return 0;
            // Replace space with T to make it ISO-like for some browsers
            // Safest cross-browser way is standard JS Date parse if format is standard
            return new Date(tsStr.replace(' ', 'T')).getTime();
        }

        // --- Main Polling Loop ---
        setInterval(() => {
            fetch('/api/status').then(r => r.json()).then(d => {

                const statusLabel = document.getElementById('login-status-indicator');
                const loginBtn = document.querySelector('#auth-overlay .btn-full'); // 获取登录按钮

                if (statusLabel) {
                    if (d.connection_status === 'Connected') {
                        statusLabel.innerHTML = '<i class="fas fa-check-circle"></i> Server Connected';
                        statusLabel.style.color = '#2ecc71'; // 绿色
                        if(loginBtn) loginBtn.disabled = false;
                        if(loginBtn) loginBtn.style.opacity = "1";
                    } else {
                        statusLabel.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Connecting...';
                        statusLabel.style.color = '#e74c3c'; // 红色
                        // 可选：未连接时禁用登录按钮防止误触
                        if(loginBtn) loginBtn.disabled = true;
                        if(loginBtn) loginBtn.style.opacity = "0.6";
                    }
                }

                if (d.verified) {
                    // Auth Check
                    if (document.getElementById('auth-overlay').style.display !== 'none') {
                        // Init Session
                        myInfo = { username: d.username, uid: d.uid, avatar: d.avatar };
                        document.getElementById('auth-overlay').style.display = 'none';
                        document.getElementById('app').style.display = 'flex';

                        document.getElementById('my-name-display').innerText = d.username;
                        document.getElementById('my-uid-display').innerText = "UID: " + d.uid;
                        if(d.avatar) document.getElementById('my-avatar-img').src = SERVER_URL + d.avatar;

                        // Load Friends
                        fetchFriends();

                        switchChat('global', 'Global Chat Room');
                    } else if (myInfo.username !== d.username) {
                        myInfo.username = d.username;
                        document.getElementById('my-name-display').innerText = d.username;
                    }

                    if (d.messages) {
                        processDataAndRender(d.messages);
                    }
                }

                if (d.notification) {
                    const codeMatch = d.notification.match(/Verification Code:\s*(\d{6})/);
                    if (codeMatch) {
                         const code = codeMatch[1];
                         const inputs = [document.getElementById('code'), document.getElementById('st-code')];
                         inputs.forEach(i => { if(i) i.value = code; });
                    }
                    if(d.notification !== "Media sent!") showNotification(d.notification);
                    fetch('/api/clear_notification', { method: 'POST' });
                }
            });
        }, 800);

        // --- Core Logic ---
        function processDataAndRender(messages) {
            let conversations = {};
            // ... (Sidebar 构建逻辑保持不变) ...
            conversations['global'] = {
                uid: 'global', username: 'Global Chat Room', avatar: '', lastMsg: null, unread: false
            };

            messages.forEach(m => {
               // ... (Sidebar 处理逻辑保持不变) ...
               let key = null;
               if (!m.target_uid || m.target_uid === 'global') key = 'global';
               else if (m.uid === myInfo.uid) key = m.target_uid;
               else if (m.target_uid === myInfo.uid) key = m.uid;

               if (key) {
                   if (!conversations[key]) {
                        const friend = friendsList.find(f => f.uid === key);
                        const partnerName = friend ? friend.username : ((m.uid === myInfo.uid) ? 'User ' + key : m.sender);
                        conversations[key] = { uid: key, username: partnerName, avatar: null, lastMsg: null, unread: false };
                   }
                   conversations[key].lastMsg = m;
                   if (key !== 'global' && m.uid === key) conversations[key].username = m.sender;

                   // Unread Check
                   if (key !== 'global' && m.uid !== myInfo.uid && currentTarget !== key) {
                         const msgTime = parseTimestamp(m.timestamp);
                         const lastReadTime = lastReadMap[key] || 0;
                         if (msgTime > lastReadTime) conversations[key].unread = true;
                   }
               }
            });

            // Sidebar fallback (keeping existing logic)
            if (currentTarget !== 'global' && !conversations[currentTarget]) {
                const friend = friendsList.find(f => f.uid === currentTarget);
                conversations[currentTarget] = {
                    uid: currentTarget,
                    username: friend ? friend.username : ('User ' + currentTarget),
                    avatar: null, lastMsg: null, unread: false
                };
            }
            renderSidebar(conversations);

            // --- 修改重点：处理当前聊天窗口的消息 ---
            const relevantMsgs = messages.filter(m => {
                if (currentTarget === 'global') return !m.target_uid || m.target_uid === 'global';
                return (m.uid === myInfo.uid && m.target_uid === currentTarget) ||
                       (m.uid === currentTarget && m.target_uid === myInfo.uid);
            });

            // 不再比较 length，直接传入追加渲染 (false = append mode)
            // renderMessages 内部会根据指纹去重，如果消息已在历史记录里，则不会重复渲染
            if (relevantMsgs.length > 0) {
                renderMessages(relevantMsgs, false);
            }
        }

        function renderSidebar(convs) {
            const container = document.getElementById('chat-tabs-container');
            container.innerHTML = '';

            const sortedKeys = Object.keys(convs).sort((a, b) => {
                if (a === 'global') return -1;
                if (b === 'global') return 1;
                const timeA = convs[a].lastMsg ? convs[a].lastMsg.timestamp : '';
                const timeB = convs[b].lastMsg ? convs[b].lastMsg.timestamp : '';
                return timeB.localeCompare(timeA);
            });

            sortedKeys.forEach(key => {
                const c = convs[key];
                const isActive = (key === currentTarget);
                const isGlobal = (key === 'global');

                let preview = "No messages";
                let timeStr = "";
                if (c.lastMsg) {
                    if (c.lastMsg.type === 'image') preview = "[Image]";
                    else if (c.lastMsg.type === 'video') preview = "[Video]";
                    else preview = c.lastMsg.content.substring(0, 10) + (c.lastMsg.content.length>10 ? "..." : "");

                    if (c.lastMsg.timestamp) {
                        const parts = c.lastMsg.timestamp.split(' ');
                        if(parts.length > 1) {
                            const timeParts = parts[1].split(':');
                            timeStr = `${timeParts[0]}:${timeParts[1]}`;
                        }
                    }
                }

                let avaSrc = "";
                if (isGlobal) {
                    avaSrc = "https://ui-avatars.com/api/?name=Global&background=0084ff&color=fff";
                } else {
                    avaSrc = `${SERVER_URL}/api/avatar/${c.uid}`;
                }

                const div = document.createElement('div');
                div.className = `tab-item ${isActive ? 'active' : ''} ${c.unread ? 'unread' : ''}`;
                div.onclick = () => switchChat(c.uid, c.username);

                div.innerHTML = `
                    <div class="tab-avatar-container">
                        <img src="${avaSrc}" class="tab-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${c.username}'">
                        <div class="unread-dot"></div>
                    </div>
                    <div class="tab-content">
                        <div class="tab-top">
                            <span class="tab-name">${c.username}</span>
                            <span class="tab-time">${timeStr}</span>
                        </div>
                        <div class="tab-preview">${preview}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderMessages(msgs, clearMode = false) {
            const list = document.getElementById('msg-list');
            // ... (保留原有 clearMode 逻辑) ...
            let tempUploads = [];
            if (clearMode) {
                list.querySelectorAll('[id^="t_"]').forEach(el => tempUploads.push(el));
                list.innerHTML = '';
                renderedFingerprints.clear();
            }

            let hasNewContent = false;

            // 读取设置
            const hideAdminGlobal = localStorage.getItem('hide_admin_global') === 'true';

            msgs.forEach(msg => {
                // --- 新增过滤逻辑 ---
                // 如果是 Global 聊天，且消息来自 ADMIN，且用户开启了屏蔽
                if (currentTarget === 'global' && msg.uid === 'ADMIN' && hideAdminGlobal) {
                    return; // 跳过此消息渲染
                }
                // ------------------

                // ... (保留原有的指纹去重和渲染逻辑) ...
                const msgFingerprint = `${msg.uid}-${msg.timestamp}-${msg.content}`;
                if (renderedFingerprints.has(msgFingerprint)) return;
                renderedFingerprints.add(msgFingerprint);
                hasNewContent = true;

                // ... (保留原有 DOM 创建逻辑) ...
                const isSelf = (msg.uid === myInfo.uid);
                const row = document.createElement('div');
                // ... (继续原有渲染代码)
                // 请确保将原有的 renderMessages 剩余部分复制完整
                // ...

                // 注意：在 renderMessages 内部修改完逻辑后，要确保 list.appendChild(row) 执行
                // 这里为了节省篇幅，假设你把原有的 DOM 组装代码保留在了这里

                // === 为了完整性，这里简写了渲染部分，请保留原文件逻辑 ===
                row.className = `message-row ${isSelf ? 'self' : 'other'}`;
                // ...

                 const avatarSrc = isSelf ?
                        (myInfo.avatar ? SERVER_URL + myInfo.avatar : `https://ui-avatars.com/api/?name=${myInfo.username}`) :
                        `${SERVER_URL}/api/avatar/${msg.uid}`;

                    let avatarHtml = '';
                    if (isSelf) {
                        avatarHtml = `<img src="${avatarSrc}" class="chat-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${msg.sender}'">`;
                    } else {
                        const safeU = msg.sender.replace(/'/g, "\\'");
                        const safeA = avatarSrc.replace(/'/g, "\\'");
                        avatarHtml = `<img src="${avatarSrc}" class="chat-avatar" onclick="showUserCard('${msg.uid}', '${safeU}', '${safeA}')" onerror="this.src='https://ui-avatars.com/api/?name=${msg.sender}'">`;
                    }

                    let contentHtml = '';
                    const fullMediaUrl = (msg.content && msg.content.startsWith('/uploads')) ? SERVER_URL + msg.content : msg.content;

                    if (msg.type === 'image') {
                        contentHtml = `<img src="${fullMediaUrl}" class="chat-media" onclick="window.open(this.src)" loading="lazy">`;
                    } else if (msg.type === 'video') {
                        contentHtml = `<video src="${fullMediaUrl}" class="chat-media" controls preload="metadata"></video>`;
                    } else {
                        const bubble = document.createElement('div');
                        bubble.className = 'msg-bubble';
                        bubble.innerText = msg.content;
                        contentHtml = bubble.outerHTML;
                    }

                    row.innerHTML = `
                        ${avatarHtml}
                        <div class="msg-content-group">
                            <div class="msg-timestamp">${msg.timestamp || ''}</div>
                            ${contentHtml}
                        </div>
                    `;

                list.appendChild(row);
            });

            if (clearMode) {
                tempUploads.forEach(el => list.appendChild(el));
            }

            if (hasNewContent || clearMode) {
                list.scrollTop = list.scrollHeight;
            }
        }

        function switchChat(uid, name) {
            currentTarget = uid;

            // 更新最后阅读时间
            lastReadMap[uid] = Date.now();

            // 更新标题
            document.getElementById('current-chat-title').innerText = name || (uid === 'global' ? 'Global Chat Room' : 'Chat');

            // 清空视图 & 指纹
            document.getElementById('msg-list').innerHTML = '';
            renderedFingerprints.clear();

            // 显示加载动画
            const list = document.getElementById('msg-list');
            list.innerHTML = `
                <div style="display:flex; justify-content:center; align-items:center; height:100%; color:#888;">
                    <div style="text-align:center;">
                        <i class="fas fa-circle-notch fa-spin" style="font-size: 2rem; margin-bottom: 10px; color: var(--primary-color);"></i>
                        <div>Loading history...</div>
                    </div>
                </div>
            `;

            // 获取限制
            const limit = parseInt(localStorage.getItem('chat_history_limit')) || 128;

            // 不再直接 emit，而是请求 Python 代理
            fetch('/api/request_history', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    target_uid: uid,
                    limit: limit
                })
            })
            .then(r => r.json())
            .then(resp => {
                if (resp.status === 'ok') {
                    // 拿到数据，渲染界面
                    // 使用 true (clearMode) 清除 Loading 提示并渲染
                    if (resp.messages.length === 0) {
                         list.innerHTML = `<div style="text-align:center; padding-top:50px; color:#ccc;">No history found.</div>`;
                    } else {
                         renderMessages(resp.messages, true);
                    }
                } else {
                    console.error("Failed to load history:", resp.msg);
                    list.innerHTML = `<div style="text-align:center; padding-top:50px; color:#e74c3c;">Error: ${resp.msg}</div>`;
                }
            })
            .catch(err => {
                console.error("API Error:", err);
                list.innerHTML = `<div style="text-align:center; padding-top:50px; color:#e74c3c;">Network Error</div>`;
            });
        }

        function sendMsg() {
            const input = document.getElementById('msg-text');
            const text = input.value.trim();
            if(!text) return;
            fetch('/api/send_message', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ content: text, type: 'text', target_uid: currentTarget })
            });
            input.value = '';
            // Optimization: Set read time to now so my own message doesn't trigger unread (logic already handles UID check, but safe to add)
            lastReadMap[currentTarget] = Date.now();
        }
        // 新增：压缩图片的辅助函数
        async function compressImage(file, targetSizeKB) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // 保持原始宽高比
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        // 迭代调整质量，尝试接近目标大小 (140KB)
                        let quality = 0.7;
                        let dataUrl = canvas.toDataURL('image/jpeg', quality);

                        // 如果压缩后还是太大，继续降低质量
                        while (dataUrl.length / 1024 > targetSizeKB && quality > 0.1) {
                            quality -= 0.1;
                            dataUrl = canvas.toDataURL('image/jpeg', quality);
                        }

                        // 将 DataURL 转回 Blob
                        const byteString = atob(dataUrl.split(',')[1]);
                        const ab = new ArrayBuffer(byteString.length);
                        const ia = new Uint8Array(ab);
                        for (let i = 0; i < byteString.length; i++) {
                            ia[i] = byteString.charCodeAt(i);
                        }
                        resolve(new Blob([ab], { type: 'image/jpeg' }));
                    };
                };
            });
        }

        async function handleMediaUpload(input) {
            if (!input.files[0]) return;
            let file = input.files[0];
            const originalSizeKB = file.size / 1024;

            // --- 1. Automatic Compression (For images exceeding 196KB) ---
            if (originalSizeKB > 196 && file.type.startsWith('image/')) {
                showNotification("File size exceeds 196KB. Compressing...");
                file = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);

                            let quality = 0.8;
                            let resultBlob = file;

                            const checkAndCompress = (q) => {
                                const dataUrl = canvas.toDataURL('image/jpeg', q);
                                const byteString = atob(dataUrl.split(',')[1]);
                                const ab = new ArrayBuffer(byteString.length);
                                const ia = new Uint8Array(ab);
                                for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
                                return new Blob([ab], { type: 'image/jpeg' });
                            };

                            resultBlob = checkAndCompress(quality);
                            // Iterate quality down to reach target around 140KB
                            while (resultBlob.size / 1024 > 140 && quality > 0.1) {
                                quality -= 0.1;
                                resultBlob = checkAndCompress(quality);
                            }
                            resolve(resultBlob);
                        };
                    };
                });
            }

            // --- 2. Final Size Validation (Must not exceed 300KB) ---
            const finalSizeKB = file.size / 1024;
            if (finalSizeKB > 300) {
                showNotification(`File too large (${Math.round(finalSizeKB)}KB). Max limit is 300KB.`);
                input.value = '';
                return;
            }

            // --- 3. Upload Logic ---
            const tempId = "t_" + Date.now();
            const list = document.getElementById('msg-list');
            const row = document.createElement('div');
            row.className = "message-row self";
            row.id = tempId;
            row.innerHTML = `
                <div class="msg-content-group">
                    <div class="upload-progress-container">
                        <div style="font-size:11px; font-weight:bold;">Uploading...</div>
                        <progress id="p-${tempId}" value="0" max="100"></progress>
                    </div>
                </div>`;
            list.appendChild(row);
            list.scrollTop = list.scrollHeight;

            const fd = new FormData();
            const fileName = file.type === 'image/jpeg' ? "compressed_image.jpg" : file.name;
            fd.append('file', file, fileName);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', SERVER_URL + '/api/upload_media', true);

            xhr.upload.onprogress = (e) => {
                if(e.lengthComputable) {
                    const prog = document.getElementById(`p-${tempId}`);
                    if(prog) prog.value = (e.loaded / e.total) * 100;
                }
            };

            xhr.onload = () => {
                if (xhr.status === 200) {
                    const r = JSON.parse(xhr.responseText);
                    fetch('/api/send_message', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            content: r.url,
                            type: file.type.startsWith('video') ? 'video' : 'image',
                            target_uid: currentTarget
                        })
                    });
                    row.remove();
                } else {
                    showNotification("Upload failed: Exceeds server limits.");
                    row.remove();
                }
            };

            xhr.onerror = () => {
                showNotification("Network error. Upload interrupted.");
                row.remove();
            };

            xhr.send(fd);
            input.value = '';
        }

        function fetchFriends() {
            fetch('/api/get_friends')
                .then(r => r.json())
                .then(data => {
                    // data 应该是 [{uid, username, avatar}, ...]
                    friendsList = data;

                    // 如果好友菜单当前是打开状态，立即刷新列表UI
                    const modal = document.getElementById('friends-modal');
                    if (modal && modal.style.display === 'flex') {
                        openFriendsModal();
                    }
                })
                .catch(e => console.error("Fetch friends error:", e));
        }

        function showUserCard(uid, username, avatarSrc) {
            if (uid === myInfo.uid) return;
            currentCardUser = { uid, username, avatar: avatarSrc };
            document.getElementById('uc-avatar').src = avatarSrc;
            document.getElementById('uc-username').innerText = username;
            document.getElementById('uc-uid').innerText = "UID: " + uid;
            document.getElementById('user-card-overlay').style.display = 'flex';
        }

        function closeUserCard() { document.getElementById('user-card-overlay').style.display = 'none'; }

        function startPrivateChatFromCard() {
            if(currentCardUser.uid) {
                switchChat(currentCardUser.uid, currentCardUser.username);
                closeUserCard();
            }
        }

        function addFriendAction() {
            // Send to Backend
            fetch('/api/add_friend', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(currentCardUser)
            }).then(r => r.json()).then(d => {
                if(d.status === 'ok') {
                    showNotification("Friend Added!");
                    fetchFriends(); // Reload list
                } else if (d.status === 'exists') {
                    showNotification("Already Friends");
                }
            });
            closeUserCard();
        }

        function openFriendsModal() {
            const container = document.getElementById('friends-list-container');
            container.innerHTML = '';

            // 构建显示列表：Admin + 实际好友
            // Admin 默认作为好友显示，但不可删除（或者可以只是隐藏）
            const displayList = [
                {uid: 'ADMIN', username: 'System Admin', avatar: ''},
                ...friendsList
            ];

            if (displayList.length === 0) {
                container.innerHTML = '<p style="color:#999; text-align:center;">No friends found.</p>';
            } else {
                displayList.forEach(f => {
                    const div = document.createElement('div');
                    div.className = 'friend-item';

                    // 点击行进入聊天
                    div.onclick = (e) => {
                        switchChat(f.uid, f.username);
                        closeFriendsModal();
                    };

                    const ava = f.uid === 'ADMIN'
                        ? "https://ui-avatars.com/api/?name=Admin&background=000&color=fff"
                        : `${SERVER_URL}/api/avatar/${f.uid}`;

                    // 生成三点菜单 (Admin 不显示删除选项)
                    let menuHtml = '';
                    if (f.uid !== 'ADMIN') {
                        menuHtml = `
                            <div class="friend-actions" onclick="event.stopPropagation()">
                                <button class="friend-menu-btn" onclick="toggleFriendMenu(this, '${f.uid}')">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div id="f-menu-${f.uid}" class="friend-dropdown">
                                    <div class="friend-dropdown-item" onclick="deleteFriend('${f.uid}')">Delete</div>
                                </div>
                            </div>
                        `;
                    }

                    div.innerHTML = `
                        <img src="${ava}" class="friend-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${f.username}'">
                        <div style="flex:1;">
                            <div style="font-weight:bold;">${f.username}</div>
                            <div style="font-size:0.8rem; color:#888;">UID: ${f.uid}</div>
                        </div>
                        ${menuHtml}
                    `;
                    container.appendChild(div);
                });
            }
            document.getElementById('friends-modal').style.display = 'flex';
        }

        // --- 新增：切换好友菜单显示 ---
        function toggleFriendMenu(btn, uid) {
            // 关闭其他打开的菜单
            document.querySelectorAll('.friend-dropdown').forEach(el => el.classList.remove('show'));

            const menu = document.getElementById(`f-menu-${uid}`);
            if (menu) menu.classList.toggle('show');
        }

        // --- 新增：删除好友逻辑 ---
        function deleteFriend(uid) {
            if(!confirm("Are you sure you want to delete this friend?")) return;

            fetch('/api/delete_friend', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ uid: uid })
            })
            .then(r => r.json())
            .then(data => {
                if(data.status === 'ok') {
                    // 更新本地列表
                    friendsList = friendsList.filter(f => f.uid !== uid);
                    openFriendsModal(); // 刷新列表
                    showNotification("Friend deleted");
                } else {
                    showNotification("Error deleting friend");
                }
            });
        }

        // 点击窗口任意位置关闭好友小菜单
        window.addEventListener('click', function(e) {
            if (!e.target.closest('.friend-actions')) {
                document.querySelectorAll('.friend-dropdown').forEach(el => el.classList.remove('show'));
            }
        });

        function closeFriendsModal() { document.getElementById('friends-modal').style.display = 'none'; }

        // --- Settings & Auth ---
        function openSettings() {
            const prev = document.getElementById('settings-avatar-preview');
            if(myInfo.avatar) prev.src = SERVER_URL + myInfo.avatar;
            else prev.src = `https://ui-avatars.com/api/?name=${myInfo.username}`;

            document.getElementById('st-username').value = '';
            document.getElementById('st-password').value = '';
            document.getElementById('st-code').value = '';

            // 回显 limit
            const savedLimit = localStorage.getItem('chat_history_limit') || 128;
            document.getElementById('st-history-limit').value = savedLimit;

            // --- 新增：回显 "Hide Admin in Global" 设置 ---
            const hideGlobal = localStorage.getItem('hide_admin_global') === 'true';
            const hideCheckbox = document.getElementById('st-hide-admin-global');
            if (hideCheckbox) {
                hideCheckbox.checked = hideGlobal;
            }
            // ---------------------------------------------

            document.getElementById('st-error-msg').style.display='none';
            document.getElementById('settings-modal').style.display='flex';
        }
        function closeSettings() { document.getElementById('settings-modal').style.display='none'; }

        function checkPasswordInput() {
            const v = document.getElementById('st-password').value;
            document.getElementById('btn-settings-code').disabled = (v.length === 0);
        }

        function uploadAvatarImmediately(input) {
            if(input.files[0]) {
                const r = new FileReader();
                r.onload = e => {
                    const b64 = e.target.result;
                    document.getElementById('settings-avatar-preview').src = b64;
                    document.getElementById('my-avatar-img').src = b64;
                    fetch('/api/update_profile', {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({ new_avatar: b64 })
                    }).then(() => showNotification("Avatar Updated!"));
                };
                r.readAsDataURL(input.files[0]);
            }
        }

        function saveProfile() {
            const u = document.getElementById('st-username').value.trim();
            const p = document.getElementById('st-password').value.trim();
            const c = document.getElementById('st-code').value.trim();
            const l = document.getElementById('st-history-limit').value.trim();

            // 保存 limit 到 localStorage
            if(l) localStorage.setItem('chat_history_limit', l);

            // --- 新增：保存 "Hide Admin in Global" 设置 ---
            const hideCheckbox = document.getElementById('st-hide-admin-global');
            if (hideCheckbox) {
                localStorage.setItem('hide_admin_global', hideCheckbox.checked);
            }

            // 如果当前正在 Global 聊天室，立即刷新以应用屏蔽/取消屏蔽
            if (currentTarget === 'global') {
                switchChat('global', 'Global Chat Room');
            }
            // ---------------------------------------------

            if(p && !c) { document.getElementById('st-error-msg').style.display='block'; return; }
            const data = {};
            if(u) data.new_username = u;
            if(p) { data.new_password = p; data.code = c; }

            if(Object.keys(data).length > 0) {
                fetch('/api/update_profile', {
                    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)
                }).then(() => {
                    showNotification("Settings Saved");
                    if(u) { myInfo.username = u; document.getElementById('my-name-display').innerText = u; }
                    closeSettings();
                });
            } else {
                showNotification("Settings Saved");
                closeSettings();
            }
        }

        function showNotification(msg) {
            const bar = document.getElementById('notification-bar');
            document.getElementById('notify-content').innerHTML = msg;
            bar.classList.add('show');
            setTimeout(() => bar.classList.remove('show'), 4000);
        }
        function requestCode() { fetch('/api/request_code', {method:'POST'}); }
        function doLogin() {
            const data = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                code: document.getElementById('code').value
            };
            fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        }
        function doLogout() {
            // 强制清除所有本地变量
            myInfo = { username: '', uid: '', avatar: '' };
            // previousMsgCount 变量似乎未在提供的片段中定义，如果在别处定义了请保留，否则可删除
            if (typeof previousMsgCount !== 'undefined') previousMsgCount = 0;
            lastReadMap = {};

            fetch('/api/logout', {method:'POST'}).then(() => {
                // 刷新页面是解决 Socket 重复监听最简单彻底的方法
                window.location.reload();
            });
        }
    </script>
</body>
</html>